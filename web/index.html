<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CitationSculptor v2.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-base: #09090b;
            --bg-surface: #18181b;
            --bg-elevated: #27272a;
            --bg-hover: #3f3f46;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent: #8b5cf6;
            --accent-hover: #a78bfa;
            --accent-muted: rgba(139, 92, 246, 0.15);
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
            --border: #27272a;
            --border-hover: #3f3f46;
            --radius: 8px;
            --radius-lg: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Layout */
        .app {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 20px 24px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent) 0%, #c084fc 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo h1 {
            font-size: 1.25rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent) 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-version {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .nav-section {
            padding: 0 12px;
            margin-bottom: 20px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px;
            margin-bottom: 4px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: var(--radius);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 14px;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            font-family: inherit;
        }

        .nav-item:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent-muted);
            color: var(--accent);
        }

        .nav-item-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .status-badge {
            margin-left: auto;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
        }

        .status-badge.online {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .status-badge.offline {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }

        /* Main Content */
        .main {
            flex: 1;
            margin-left: 260px;
            padding: 32px 40px;
            max-width: 1000px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Cards */
        .card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        input[type="text"],
        input[type="file"],
        textarea,
        select {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-muted);
        }

        input::placeholder,
        textarea::placeholder {
            color: var(--text-muted);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        select {
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn:hover {
            background: var(--accent-hover);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        /* Results */
        .result-box {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin-top: 20px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-base);
            border-bottom: 1px solid var(--border);
        }

        .result-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .result-content {
            padding: 16px;
        }

        .result-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-primary);
            user-select: all;
        }

        .result-text.inline {
            color: var(--accent);
        }

        /* Search Results */
        .search-results {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .search-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            transition: all 0.15s ease;
        }

        .search-item:hover {
            border-color: var(--border-hover);
        }

        .search-item-title {
            font-weight: 500;
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .search-item-meta {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .search-item-ids {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .id-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            padding: 4px 8px;
            background: var(--bg-base);
            border-radius: 4px;
            color: var(--text-secondary);
        }

        /* Library */
        .library-grid {
            display: grid;
            gap: 16px;
        }

        .citation-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
        }

        .citation-title {
            font-weight: 500;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .citation-meta {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .citation-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .tag {
            font-size: 11px;
            padding: 3px 8px;
            background: var(--accent-muted);
            color: var(--accent);
            border-radius: 12px;
        }

        /* File Upload */
        .file-drop {
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .file-drop:hover,
        .file-drop.dragover {
            border-color: var(--accent);
            background: var(--accent-muted);
        }

        .file-drop-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .file-drop-text {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .file-drop-hint {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-base);
            padding: 4px;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }

        .tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--accent);
            color: white;
        }

        /* Messages */
        .message {
            padding: 14px 16px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .message.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .message.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .message.info {
            background: var(--accent-muted);
            border: 1px solid rgba(139, 92, 246, 0.2);
            color: var(--accent);
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 24px;
            background: var(--success);
            color: white;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* About/Documentation Styles */
        .markdown-content {
            line-height: 1.5;
            font-size: 13px;
        }

        .markdown-content h1 {
            font-size: 1.5rem;
            margin: 20px 0 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
            color: var(--accent);
        }

        .markdown-content h1:first-child {
            margin-top: 0;
        }

        .markdown-content h2 {
            font-size: 1.2rem;
            margin: 18px 0 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }

        .markdown-content h3 {
            font-size: 1rem;
            margin: 14px 0 4px;
            color: var(--text-primary);
        }

        .markdown-content h4 {
            font-size: 0.9rem;
            margin: 10px 0 4px;
            color: var(--text-secondary);
        }

        .markdown-content p {
            margin: 6px 0;
        }

        .markdown-content ul, .markdown-content ol {
            margin: 6px 0;
            padding-left: 20px;
        }

        .markdown-content li {
            margin: 2px 0;
        }

        .markdown-content code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            padding: 1px 5px;
            background: var(--bg-base);
            border-radius: 3px;
            color: var(--accent);
        }

        .markdown-content pre {
            background: var(--bg-base);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px 12px;
            overflow-x: auto;
            margin: 8px 0;
            font-size: 12px;
            line-height: 1.4;
        }

        .markdown-content pre code {
            padding: 0;
            background: transparent;
            color: var(--text-primary);
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 12px;
        }

        .markdown-content th, .markdown-content td {
            padding: 6px 10px;
            text-align: left;
            border: 1px solid var(--border);
        }

        .markdown-content th {
            background: var(--bg-base);
            font-weight: 600;
        }

        .markdown-content tr:nth-child(even) {
            background: rgba(255,255,255,0.02);
        }

        .markdown-content blockquote {
            margin: 8px 0;
            padding: 8px 12px;
            border-left: 3px solid var(--accent);
            background: var(--accent-muted);
            border-radius: 0 var(--radius) var(--radius) 0;
            font-size: 12px;
        }

        .markdown-content a {
            color: var(--accent);
            text-decoration: none;
        }

        .markdown-content a:hover {
            text-decoration: underline;
        }

        .markdown-content hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 16px 0;
        }

        .markdown-content img {
            max-width: 100%;
            border-radius: var(--radius);
            height: 20px;
            vertical-align: middle;
        }

        /* Quick links at top of about page */
        .about-quick-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .about-quick-links a {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 5px 10px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-secondary);
            font-size: 12px;
            text-decoration: none;
            transition: all 0.15s ease;
        }

        .about-quick-links a:hover {
            background: var(--accent-muted);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Compact card for about page */
        #aboutContent.card {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .sidebar {
                width: 200px;
            }
            .main {
                margin-left: 200px;
                padding: 24px;
            }
        }

        @media (max-width: 700px) {
            .sidebar {
                position: static;
                width: 100%;
                height: auto;
            }
            .main {
                margin-left: 0;
            }
            .app {
                flex-direction: column;
            }
            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">üìö</div>
                <div>
                    <h1>CitationSculptor</h1>
                    <div class="logo-version">v2.1.0</div>
                </div>
            </div>

            <nav class="nav-section">
                <div class="nav-section-title">Citation Tools</div>
                <button type="button" class="nav-item active" data-page="lookup">
                    <span class="nav-item-icon">üîç</span>
                    Quick Lookup
                </button>
                <button type="button" class="nav-item" data-page="search">
                    <span class="nav-item-icon">üìö</span>
                    Search
                </button>
                <button type="button" class="nav-item" data-page="batch">
                    <span class="nav-item-icon">üìã</span>
                    Batch Process
                </button>
                <button type="button" class="nav-item" data-page="document">
                    <span class="nav-item-icon">üìù</span>
                    Process Document
                </button>
                <button type="button" class="nav-item" data-page="pdf">
                    <span class="nav-item-icon">üìÑ</span>
                    PDF Extract
                </button>
            </nav>

            <nav class="nav-section">
                <div class="nav-section-title">Library</div>
                <button type="button" class="nav-item" data-page="library">
                    <span class="nav-item-icon">üóÉÔ∏è</span>
                    My Citations
                </button>
                <button type="button" class="nav-item" data-page="bibliography">
                    <span class="nav-item-icon">üìù</span>
                    Bibliography
                </button>
            </nav>

            <nav class="nav-section">
                <div class="nav-section-title">Import / Export</div>
                <button type="button" class="nav-item" data-page="import">
                    <span class="nav-item-icon">üì•</span>
                    Import
                </button>
                <button type="button" class="nav-item" data-page="export">
                    <span class="nav-item-icon">üì§</span>
                    Export
                </button>
            </nav>

            <nav class="nav-section">
                <div class="nav-section-title">System</div>
                <button type="button" class="nav-item" data-page="settings">
                    <span class="nav-item-icon">‚öôÔ∏è</span>
                    Settings
                </button>
                <button type="button" class="nav-item" data-page="about">
                    <span class="nav-item-icon">‚ÑπÔ∏è</span>
                    About
                </button>
            </nav>

            <nav class="nav-section" style="margin-top: auto;">
                <div class="nav-item">
                    <span class="nav-item-icon">‚ö°</span>
                    Server
                    <span class="status-badge" id="serverStatus">...</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Quick Lookup Page -->
            <div class="page active" id="lookup">
                <div class="page-header">
                    <h2 class="page-title">Quick Lookup</h2>
                    <p class="page-subtitle">Enter any identifier: PMID, DOI, PMC ID, arXiv ID, ISBN, or article title</p>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Identifier</label>
                        <input type="text" id="lookupInput" placeholder="e.g., 37622666, 10.1093/eurheartj/ehad195, arXiv:2301.00001, 978-0-123456-78-9">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Citation Style</label>
                            <select id="styleSelect">
                                <option value="vancouver">Vancouver</option>
                                <option value="apa">APA 7th</option>
                                <option value="mla">MLA 9th</option>
                                <option value="chicago">Chicago</option>
                                <option value="harvard">Harvard</option>
                                <option value="ieee">IEEE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Format</label>
                            <select id="formatSelect">
                                <option value="full">Full Citation</option>
                                <option value="inline">Inline Only</option>
                                <option value="endnote">Endnote Only</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="doLookup()">üîç Look Up</button>
                        <button class="btn btn-secondary" onclick="copyResult()">üìã Copy</button>
                        <button class="btn btn-secondary" onclick="saveCitation()">üíæ Save</button>
                    </div>
                    <div id="lookupResult"></div>
                </div>
            </div>

            <!-- Search Page -->
            <div class="page" id="search">
                <div class="page-header">
                    <h2 class="page-title">Search</h2>
                    <p class="page-subtitle">Search across PubMed, OpenAlex, and Semantic Scholar</p>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Search Query</label>
                        <input type="text" id="searchInput" placeholder="e.g., heart failure guidelines 2023">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Source</label>
                            <select id="searchSource">
                                <option value="pubmed">PubMed</option>
                                <option value="openalex">OpenAlex</option>
                                <option value="semantic_scholar">Semantic Scholar</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Max Results</label>
                            <select id="searchMax">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="doSearch()">üîé Search</button>
                    <div id="searchResults"></div>
                </div>
            </div>

            <!-- Batch Page -->
            <div class="page" id="batch">
                <div class="page-header">
                    <h2 class="page-title">Batch Process</h2>
                    <p class="page-subtitle">Process multiple identifiers at once</p>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Enter identifiers (one per line)</label>
                        <textarea id="batchInput" placeholder="37622666&#10;10.1093/eurheartj/ehad195&#10;PMC7039045"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Citation Style</label>
                            <select id="batchStyle">
                                <option value="vancouver">Vancouver</option>
                                <option value="apa">APA 7th</option>
                                <option value="mla">MLA 9th</option>
                                <option value="chicago">Chicago</option>
                                <option value="harvard">Harvard</option>
                                <option value="ieee">IEEE</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="doBatch()">üìã Process Batch</button>
                        <button class="btn btn-secondary" onclick="copyBatchResult()">üìã Copy All</button>
                    </div>
                    <div id="batchResults"></div>
                </div>
            </div>

            <!-- Process Document Page -->
            <div class="page" id="document">
                <div class="page-header">
                    <h2 class="page-title">Process Document</h2>
                    <p class="page-subtitle">Process a markdown document, looking up all citations and updating inline references</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchDocTab('content')">Paste Content</button>
                    <button class="tab" onclick="switchDocTab('file')">File Path</button>
                </div>

                <div class="card">
                    <div id="docContentTab">
                        <div class="form-group">
                            <label class="form-label">Paste your Markdown document content</label>
                            <textarea id="docContent" placeholder="# My Document&#10;&#10;This study shows that... [1]&#10;&#10;## References&#10;&#10;1. Smith J, et al. Important findings. J Medicine. 2024;1:2-3. https://pubmed.ncbi.nlm.nih.gov/12345678/" style="min-height: 250px;"></textarea>
                        </div>
                    </div>
                    <div id="docFileTab" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Enter the path to your Markdown file</label>
                            <input type="text" id="docFilePath" placeholder="/Users/you/Documents/my-document.md">
                        </div>
                        <div class="message info" style="margin-top: 12px;" id="vault-path-hint">
                            <span>üí°</span>
                            <span id="vault-hint-text">Loading vault configuration...</span>
                        </div>
                    </div>
                    <div class="form-row" style="margin-top: 16px;">
                        <div class="form-group">
                            <label class="form-label">Citation Style</label>
                            <select id="docStyle">
                                <option value="vancouver">Vancouver</option>
                                <option value="apa">APA 7th</option>
                                <option value="mla">MLA 9th</option>
                                <option value="chicago">Chicago</option>
                                <option value="harvard">Harvard</option>
                                <option value="ieee">IEEE</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="processDocument()">‚öôÔ∏è Process Document</button>
                        <button class="btn btn-secondary" onclick="copyProcessedDoc()">üìã Copy Result</button>
                        <button class="btn btn-secondary" onclick="downloadProcessedDoc()">üíæ Download</button>
                    </div>
                    <div id="docResult"></div>
                </div>
            </div>

            <!-- PDF Extract Page -->
            <div class="page" id="pdf">
                <div class="page-header">
                    <h2 class="page-title">PDF Extraction</h2>
                    <p class="page-subtitle">Extract citation metadata from PDF files</p>
                </div>

                <div class="card">
                    <div class="file-drop" id="pdfDrop" onclick="document.getElementById('pdfFile').click()">
                        <div class="file-drop-icon">üìÑ</div>
                        <div class="file-drop-text">Drop PDF here or click to upload</div>
                        <div class="file-drop-hint">Extracts DOI, PMID, arXiv ID, title, and authors</div>
                        <input type="file" id="pdfFile" accept=".pdf" style="display: none" onchange="handlePdfUpload(event)">
                    </div>
                    <div id="pdfResult"></div>
                </div>

                <div class="message info">
                    <span>üí°</span>
                    PDF extraction requires PyMuPDF. Install with: <code>pip install PyMuPDF</code>
                </div>
            </div>

            <!-- Library Page -->
            <div class="page" id="library">
                <div class="page-header">
                    <h2 class="page-title">My Citations</h2>
                    <p class="page-subtitle">Your saved citation library with full-text search</p>
                </div>

                <div class="card">
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="librarySearch" placeholder="Search your citations...">
                        </div>
                        <button class="btn" onclick="searchLibrary()">üîç Search</button>
                        <button class="btn btn-secondary" onclick="loadLibrary()">‚Üª Refresh</button>
                    </div>
                </div>

                <div class="stats-grid" id="libraryStats">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotal">-</div>
                        <div class="stat-label">Total Citations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statTags">-</div>
                        <div class="stat-label">Tags</div>
                    </div>
                </div>

                <div id="libraryResults">
                    <div class="empty-state">
                        <div class="empty-state-icon">üóÉÔ∏è</div>
                        <p>Your citation library is empty</p>
                        <p style="font-size: 13px; margin-top: 8px;">Save citations from the Quick Lookup page</p>
                    </div>
                </div>
            </div>

            <!-- Bibliography Page -->
            <div class="page" id="bibliography">
                <div class="page-header">
                    <h2 class="page-title">Bibliography Generator</h2>
                    <p class="page-subtitle">Generate formatted bibliographies from identifiers</p>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Enter identifiers (one per line)</label>
                        <textarea id="bibInput" placeholder="Enter PMIDs, DOIs, or other identifiers..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Citation Style</label>
                            <select id="bibStyle">
                                <option value="vancouver">Vancouver</option>
                                <option value="apa">APA 7th</option>
                                <option value="mla">MLA 9th</option>
                                <option value="chicago">Chicago</option>
                                <option value="harvard">Harvard</option>
                                <option value="ieee">IEEE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sort Order</label>
                            <select id="bibSort">
                                <option value="alphabetical">Alphabetical</option>
                                <option value="appearance">Order of Appearance</option>
                                <option value="year">By Year (newest first)</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="generateBibliography()">üìù Generate</button>
                        <button class="btn btn-secondary" onclick="copyBibliography()">üìã Copy</button>
                    </div>
                    <div id="bibResult"></div>
                </div>
            </div>

            <!-- Import Page -->
            <div class="page" id="import">
                <div class="page-header">
                    <h2 class="page-title">Import Citations</h2>
                    <p class="page-subtitle">Import from BibTeX or RIS format</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchImportTab('bibtex')">BibTeX</button>
                    <button class="tab" onclick="switchImportTab('ris')">RIS</button>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label" id="importLabel">Paste BibTeX content</label>
                        <textarea id="importInput" placeholder="@article{...}"></textarea>
                    </div>
                    <button class="btn" onclick="doImport()">üì• Import</button>
                    <div id="importResult"></div>
                </div>
            </div>

            <!-- Export Page -->
            <div class="page" id="export">
                <div class="page-header">
                    <h2 class="page-title">Export Citations</h2>
                    <p class="page-subtitle">Export your library to BibTeX or RIS format</p>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Select citations to export (by ID, comma-separated)</label>
                        <input type="text" id="exportIds" placeholder="e.g., 1, 2, 3 (leave empty for all)">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Export Format</label>
                            <select id="exportFormat">
                                <option value="bibtex">BibTeX (.bib)</option>
                                <option value="ris">RIS (.ris)</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="doExport()">üì§ Export</button>
                </div>
            </div>

            <!-- Settings Page -->
            <div class="page" id="settings">
                <div class="page-header">
                    <h2 class="page-title">‚öôÔ∏è Settings</h2>
                    <p class="page-subtitle">Configure CitationSculptor preferences</p>
                </div>

                <div class="card" style="background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%); color: white; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <span style="font-size: 2rem;">üîÑ</span>
                        <div>
                            <h3 style="margin: 0 0 4px 0; color: white;">Bidirectional Settings Sync</h3>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">
                                <strong>Settings sync automatically</strong> between this Web UI and the Obsidian plugin.
                                Changes made here appear in Obsidian within seconds, and vice versa.
                                Synced: Citation Style, Backup Preference, Max Search Results.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="card" id="settingsContent">
                    <div class="loading"><div class="spinner"></div>Loading settings...</div>
                </div>
                
                <div class="card" id="settingsForm" style="display: none;">
                    <h3 style="margin-bottom: 20px; color: var(--accent);">üìÅ Obsidian Vault</h3>
                    
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label class="form-label">Obsidian Vault Path</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" class="form-input" id="settingVaultPath" 
                                   placeholder="/path/to/your/obsidian/vault" style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="openFolderBrowser()" style="white-space: nowrap;">
                                üìÇ Browse...
                            </button>
                        </div>
                        <div class="message info" style="margin-top: 8px;">
                            <span>üí°</span>
                            <span>Set this to use relative paths when processing documents</span>
                        </div>
                    </div>

                    <h3 style="margin-bottom: 20px; color: var(--accent);">üìù Citation Defaults</h3>
                    
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label class="form-label">Default Citation Style</label>
                        <select class="form-select" id="settingDefaultStyle">
                            <option value="vancouver">Vancouver (Medical)</option>
                            <option value="apa">APA 7th Edition</option>
                            <option value="mla">MLA 9th Edition</option>
                            <option value="chicago">Chicago/Turabian</option>
                            <option value="harvard">Harvard</option>
                            <option value="ieee">IEEE</option>
                        </select>
                    </div>

                    <h3 style="margin-bottom: 20px; color: var(--accent);">üõ°Ô∏è Safety Features</h3>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="settingCreateBackup" style="width: 18px; height: 18px;">
                            <span>Create backup before processing documents</span>
                        </label>
                    </div>

                    <h3 style="margin-bottom: 20px; color: var(--accent);">üß† Document Intelligence</h3>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="settingVerifyLinks" style="width: 18px; height: 18px;">
                            <span>Verify links by default when analyzing documents</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="settingSuggestCitations" style="width: 18px; height: 18px;">
                            <span>Suggest citations by default</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="settingCheckCompliance" style="width: 18px; height: 18px;">
                            <span>Check citation compliance by default</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="settingEnableLLM" style="width: 18px; height: 18px;">
                            <span>Enable LLM-powered metadata extraction (requires Ollama)</span>
                        </label>
                    </div>

                    <h3 style="margin-bottom: 20px; color: var(--accent);">üîç Search</h3>
                    
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label class="form-label">Maximum Search Results</label>
                        <input type="number" class="form-input" id="settingMaxResults" 
                               min="5" max="50" value="10" style="width: 100px;">
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 32px; padding-top: 20px; border-top: 1px solid var(--border);">
                        <button type="button" class="btn btn-primary" onclick="saveSettings()">
                            üíæ Save Settings
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetSettings()">
                            üîÑ Reset to Defaults
                        </button>
                    </div>
                    
                    <div id="settingsMessage" style="margin-top: 16px;"></div>
                </div>
            </div>

            <!-- About Page -->
            <div class="page" id="about">
                <div class="page-header">
                    <h2 class="page-title">About CitationSculptor</h2>
                    <p class="page-subtitle">The comprehensive citation management toolkit for researchers</p>
                </div>

                <div class="card" id="aboutContent">
                    <div class="loading"><div class="spinner"></div>Loading documentation...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Folder Browser Modal -->
    <div id="folderBrowserModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; border-bottom: 1px solid var(--border);">
                <h3 style="margin: 0; color: var(--accent);">üìÇ Select Obsidian Vault</h3>
                <button onclick="closeFolderBrowser()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            </div>
            
            <div id="folderBrowserPath" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin: 16px 0; font-family: monospace; font-size: 0.9rem; word-break: break-all;">
                Loading...
            </div>
            
            <div id="folderBrowserContent" style="flex: 1; overflow-y: auto; min-height: 200px; max-height: 400px;">
                <div class="loading"><div class="spinner"></div>Loading directories...</div>
            </div>
            
            <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 16px; border-top: 1px solid var(--border); margin-top: 16px;">
                <button type="button" class="btn btn-secondary" onclick="closeFolderBrowser()">Cancel</button>
                <button type="button" class="btn btn-primary" id="selectFolderBtn" onclick="selectCurrentFolder()" disabled>
                    ‚úì Select This Folder
                </button>
            </div>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border);
        }
        .folder-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid transparent;
        }
        .folder-item:hover {
            background: var(--bg-secondary);
        }
        .folder-item.vault {
            border-color: var(--accent);
            background: rgba(147, 112, 219, 0.1);
        }
        .folder-item .icon {
            font-size: 1.3rem;
        }
        .folder-item .name {
            flex: 1;
            font-weight: 500;
        }
        .folder-item .badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            background: var(--accent);
            color: white;
        }
        .folder-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .folder-nav:hover {
            background: var(--bg-tertiary);
        }
        .empty-folder {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
    </style>

    <script>
        const API = 'http://127.0.0.1:3019';
        let lastResult = null;
        let lastBatch = null;
        let lastBibliography = null;
        let currentImportType = 'bibtex';

        // Navigation
        document.querySelectorAll('.nav-item[data-page]').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                item.classList.add('active');
                document.getElementById(item.dataset.page).classList.add('active');
            });
        });

        // Enter key handlers
        document.getElementById('lookupInput').addEventListener('keypress', e => { if (e.key === 'Enter') doLookup(); });
        document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') doSearch(); });
        document.getElementById('librarySearch').addEventListener('keypress', e => { if (e.key === 'Enter') searchLibrary(); });

        // PDF Drop Zone
        const pdfDrop = document.getElementById('pdfDrop');
        pdfDrop.addEventListener('dragover', e => { e.preventDefault(); pdfDrop.classList.add('dragover'); });
        pdfDrop.addEventListener('dragleave', () => pdfDrop.classList.remove('dragover'));
        pdfDrop.addEventListener('drop', e => {
            e.preventDefault();
            pdfDrop.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                processPdfFile(e.dataTransfer.files[0]);
            }
        });

        // Check server status
        async function checkServer() {
            const badge = document.getElementById('serverStatus');
            try {
                const res = await fetch(`${API}/health`);
                const data = await res.json();
                if (data.status === 'ok') {
                    badge.textContent = 'Online';
                    badge.className = 'status-badge online';
                }
            } catch (e) {
                badge.textContent = 'Offline';
                badge.className = 'status-badge offline';
            }
        }

        // Lookup
        async function doLookup() {
            const input = document.getElementById('lookupInput').value.trim();
            if (!input) return;

            const style = document.getElementById('styleSelect').value;
            const container = document.getElementById('lookupResult');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Looking up...</div>';

            try {
                const res = await fetch(`${API}/api/lookup?id=${encodeURIComponent(input)}&style=${style}`);
                const data = await res.json();
                lastResult = data;

                if (data.success) {
                    container.innerHTML = `
                        <div class="result-box">
                            <div class="result-header">
                                <span class="result-label">Inline Reference</span>
                                <button class="btn btn-sm btn-secondary" onclick="copyText('${esc(data.inline_mark)}')">Copy</button>
                            </div>
                            <div class="result-content">
                                <div class="result-text inline">${escHtml(data.inline_mark)}</div>
                            </div>
                        </div>
                        <div class="result-box">
                            <div class="result-header">
                                <span class="result-label">Full Citation</span>
                                <button class="btn btn-sm btn-secondary" onclick="copyText(\`${esc(data.full_citation)}\`)">Copy</button>
                            </div>
                            <div class="result-content">
                                <div class="result-text">${escHtml(data.full_citation)}</div>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error || 'Not found')}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        // Save citation to library
        async function saveCitation() {
            if (!lastResult || !lastResult.success) {
                showToast('No citation to save', 'error');
                return;
            }

            try {
                const res = await fetch(`${API}/api/library/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        citation: {
                            identifier_type: lastResult.identifier_type,
                            identifier: lastResult.identifier,
                            title: lastResult.metadata?.title || '',
                            authors: lastResult.metadata?.authors || [],
                            year: lastResult.metadata?.year || '',
                            style: document.getElementById('styleSelect').value,
                            inline_mark: lastResult.inline_mark,
                            full_citation: lastResult.full_citation,
                            metadata: lastResult.metadata,
                            tags: [],
                        }
                    })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Citation saved to library!');
                } else {
                    showToast(data.error || 'Save failed', 'error');
                }
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        // Search
        async function doSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            const source = document.getElementById('searchSource').value;
            const max = document.getElementById('searchMax').value;
            const container = document.getElementById('searchResults');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Searching...</div>';

            try {
                const res = await fetch(`${API}/api/search?q=${encodeURIComponent(query)}&source=${source}&max=${max}`);
                const data = await res.json();

                if (data.results && data.results.length > 0) {
                    container.innerHTML = `
                        <div style="margin-top: 16px; color: var(--text-secondary); font-size: 13px;">
                            Found ${data.count} result(s) from ${source}
                        </div>
                        <div class="search-results">
                            ${data.results.map((r, i) => `
                                <div class="search-item">
                                    <div class="search-item-title">${i + 1}. ${escHtml(r.title || 'Untitled')}</div>
                                    <div class="search-item-meta">
                                        ${escHtml((r.authors || []).slice(0, 2).join(', '))}${r.authors?.length > 2 ? ' et al.' : ''} ¬∑ ${escHtml(r.journal || '')} (${r.year || 'n.d.'})
                                    </div>
                                    <div class="search-item-ids">
                                        ${r.pmid ? `<span class="id-badge">PMID: ${r.pmid}</span>` : ''}
                                        ${r.doi ? `<span class="id-badge">DOI: ${escHtml(r.doi)}</span>` : ''}
                                        ${r.citation_count ? `<span class="id-badge">Cited: ${r.citation_count}</span>` : ''}
                                    </div>
                                    <div class="btn-group">
                                        <button class="btn btn-sm" onclick="getCitation('${r.pmid || r.doi || ''}')">Get Citation</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><p>No results found</p></div>';
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        async function getCitation(id) {
            document.getElementById('lookupInput').value = id;
            document.querySelector('[data-page="lookup"]').click();
            await doLookup();
        }

        // Batch
        async function doBatch() {
            const input = document.getElementById('batchInput').value.trim();
            if (!input) return;

            const identifiers = input.split('\n').map(s => s.trim()).filter(s => s && !s.startsWith('#'));
            const style = document.getElementById('batchStyle').value;
            const container = document.getElementById('batchResults');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Processing...</div>';

            try {
                const res = await fetch(`${API}/api/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifiers, style })
                });
                const data = await res.json();
                lastBatch = data.results;

                const successful = data.results.filter(r => r.success);
                const failed = data.results.filter(r => !r.success);

                container.innerHTML = `
                    <div style="margin-top: 16px; color: var(--text-secondary);">
                        <span style="color: var(--success);">‚úì ${successful.length} successful</span>
                        ${failed.length > 0 ? `<span style="color: var(--error); margin-left: 16px;">‚úó ${failed.length} failed</span>` : ''}
                    </div>
                    ${successful.length > 0 ? `
                        <div class="result-box" style="margin-top: 16px;">
                            <div class="result-header">
                                <span class="result-label">Citations</span>
                            </div>
                            <div class="result-content">
                                <textarea readonly style="width: 100%; min-height: 200px; background: var(--bg-base); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 12px;">${successful.map(r => r.full_citation).join('\n\n')}</textarea>
                            </div>
                        </div>
                    ` : ''}
                    ${failed.length > 0 ? `
                        <div class="message error" style="margin-top: 16px;">
                            Failed: ${failed.map(r => escHtml(r.identifier)).join(', ')}
                        </div>
                    ` : ''}
                `;
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        function copyBatchResult() {
            if (!lastBatch) return;
            const text = lastBatch.filter(r => r.success).map(r => r.full_citation).join('\n\n');
            copyText(text);
        }

        // PDF Upload
        function handlePdfUpload(event) {
            const file = event.target.files[0];
            if (file) processPdfFile(file);
        }

        async function processPdfFile(file) {
            const container = document.getElementById('pdfResult');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Extracting metadata...</div>';

            try {
                const base64 = await fileToBase64(file);
                const res = await fetch(`${API}/api/pdf/extract`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pdf_base64: base64 })
                });
                const data = await res.json();

                if (data.success) {
                    const m = data.metadata;
                    container.innerHTML = `
                        <div class="result-box">
                            <div class="result-header">
                                <span class="result-label">Extracted Metadata</span>
                            </div>
                            <div class="result-content">
                                <p><strong>Title:</strong> ${escHtml(m.title || 'Not found')}</p>
                                <p><strong>Authors:</strong> ${escHtml((m.authors || []).join(', ') || 'Not found')}</p>
                                <p><strong>DOI:</strong> ${escHtml(m.doi || 'Not found')}</p>
                                <p><strong>PMID:</strong> ${escHtml(m.pmid || 'Not found')}</p>
                                <p><strong>arXiv ID:</strong> ${escHtml(m.arxiv_id || 'Not found')}</p>
                                <p><strong>Pages:</strong> ${m.page_count || 'Unknown'}</p>
                            </div>
                        </div>
                        ${data.citation ? `
                            <div class="result-box">
                                <div class="result-header">
                                    <span class="result-label">Generated Citation</span>
                                    <button class="btn btn-sm btn-secondary" onclick="copyText(\`${esc(data.citation.full_citation)}\`)">Copy</button>
                                </div>
                                <div class="result-content">
                                    <div class="result-text">${escHtml(data.citation.full_citation)}</div>
                                </div>
                            </div>
                        ` : `
                            <div class="message info">No identifier found. Try searching by title.</div>
                        `}
                    `;
                } else {
                    container.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error)}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Library
        async function loadLibrary() {
            const container = document.getElementById('libraryResults');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            try {
                const [libRes, tagsRes] = await Promise.all([
                    fetch(`${API}/api/library`),
                    fetch(`${API}/api/library/tags`)
                ]);
                const libData = await libRes.json();
                const tagsData = await tagsRes.json();

                document.getElementById('statTotal').textContent = libData.total || 0;
                document.getElementById('statTags').textContent = (tagsData.tags || []).length;

                if (libData.citations && libData.citations.length > 0) {
                    container.innerHTML = `
                        <div class="library-grid">
                            ${libData.citations.map(c => `
                                <div class="citation-card">
                                    <div class="citation-title">${escHtml(c.title || 'Untitled')}</div>
                                    <div class="citation-meta">${escHtml((c.authors || []).slice(0, 2).join(', '))}${c.authors?.length > 2 ? ' et al.' : ''} (${c.year || 'n.d.'})</div>
                                    ${c.tags && c.tags.length ? `
                                        <div class="citation-tags">
                                            ${c.tags.map(t => `<span class="tag">${escHtml(t)}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-secondary" onclick="copyText(\`${esc(c.full_citation)}\`)">Copy</button>
                                        <button class="btn btn-sm btn-secondary" onclick="deleteCitation(${c.id})">Delete</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üóÉÔ∏è</div><p>Your library is empty</p></div>';
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        async function searchLibrary() {
            const query = document.getElementById('librarySearch').value.trim();
            if (!query) { loadLibrary(); return; }

            const container = document.getElementById('libraryResults');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Searching...</div>';

            try {
                const res = await fetch(`${API}/api/library/search?q=${encodeURIComponent(query)}`);
                const data = await res.json();

                if (data.citations && data.citations.length > 0) {
                    container.innerHTML = `
                        <div class="library-grid">
                            ${data.citations.map(c => `
                                <div class="citation-card">
                                    <div class="citation-title">${escHtml(c.title || 'Untitled')}</div>
                                    <div class="citation-meta">${escHtml((c.authors || []).join(', '))} (${c.year})</div>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-secondary" onclick="copyText(\`${esc(c.full_citation)}\`)">Copy</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><p>No citations match your search</p></div>';
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        async function deleteCitation(id) {
            if (!confirm('Delete this citation?')) return;
            try {
                await fetch(`${API}/api/library/delete?id=${id}`, { method: 'DELETE' });
                showToast('Citation deleted');
                loadLibrary();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        // Bibliography
        async function generateBibliography() {
            const input = document.getElementById('bibInput').value.trim();
            if (!input) return;

            const identifiers = input.split('\n').map(s => s.trim()).filter(s => s && !s.startsWith('#'));
            const style = document.getElementById('bibStyle').value;
            const sort = document.getElementById('bibSort').value;
            const container = document.getElementById('bibResult');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Generating bibliography...</div>';

            try {
                const res = await fetch(`${API}/api/bibliography/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifiers, style, sort })
                });
                const data = await res.json();
                lastBibliography = data.bibliography;

                container.innerHTML = `
                    <div style="margin-top: 16px; color: var(--text-secondary); font-size: 13px;">
                        Generated ${data.entries} citations ${data.failed > 0 ? `(${data.failed} failed)` : ''}
                    </div>
                    <div class="result-box" style="margin-top: 16px;">
                        <div class="result-header">
                            <span class="result-label">Bibliography</span>
                        </div>
                        <div class="result-content">
                            <textarea readonly style="width: 100%; min-height: 300px; background: var(--bg-base); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 12px;">${escHtml(data.bibliography)}</textarea>
                        </div>
                    </div>
                `;
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        function copyBibliography() {
            if (lastBibliography) copyText(lastBibliography);
        }

        // Import
        function switchImportTab(type) {
            currentImportType = type;
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tabs .tab:${type === 'bibtex' ? 'first-child' : 'last-child'}`).classList.add('active');
            document.getElementById('importLabel').textContent = `Paste ${type === 'bibtex' ? 'BibTeX' : 'RIS'} content`;
            document.getElementById('importInput').placeholder = type === 'bibtex' ? '@article{...}' : 'TY  - JOUR\n...';
        }

        async function doImport() {
            const input = document.getElementById('importInput').value.trim();
            if (!input) return;

            const container = document.getElementById('importResult');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Importing...</div>';

            try {
                const res = await fetch(`${API}/api/import/${currentImportType}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [currentImportType]: input })
                });
                const data = await res.json();

                if (data.imported > 0) {
                    container.innerHTML = `
                        <div class="message success">‚úì Imported ${data.imported} citation(s)</div>
                        <div class="search-results">
                            ${data.results.map(r => `
                                <div class="search-item">
                                    <div class="search-item-title">${escHtml(r.inline_mark || r.identifier)}</div>
                                    <div class="result-text" style="font-size: 12px; margin-top: 8px;">${escHtml(r.full_citation || '')}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error || 'No valid entries found')}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        // Export
        async function doExport() {
            const ids = document.getElementById('exportIds').value.trim();
            const format = document.getElementById('exportFormat').value;

            if (!ids) {
                showToast('Please enter citation IDs to export', 'error');
                return;
            }

            window.open(`${API}/api/export/${format}?ids=${encodeURIComponent(ids)}`, '_blank');
        }

        // Document Processing
        let currentDocTab = 'content';
        let lastProcessedDoc = null;

        function switchDocTab(tab) {
            currentDocTab = tab;
            document.querySelectorAll('#document .tabs .tab').forEach((t, i) => {
                t.classList.toggle('active', (tab === 'content' && i === 0) || (tab === 'file' && i === 1));
            });
            document.getElementById('docContentTab').style.display = tab === 'content' ? 'block' : 'none';
            document.getElementById('docFileTab').style.display = tab === 'file' ? 'block' : 'none';
        }

        async function processDocument() {
            const style = document.getElementById('docStyle').value;
            const container = document.getElementById('docResult');
            
            let requestBody = { style };
            
            if (currentDocTab === 'content') {
                const content = document.getElementById('docContent').value.trim();
                if (!content) {
                    showToast('Please paste document content', 'error');
                    return;
                }
                requestBody.content = content;
            } else {
                const filePath = document.getElementById('docFilePath').value.trim();
                if (!filePath) {
                    showToast('Please enter a file path', 'error');
                    return;
                }
                requestBody.file_path = filePath;
            }

            container.innerHTML = '<div class="loading"><div class="spinner"></div>Processing document... This may take a while for documents with many references.</div>';

            try {
                const res = await fetch(`${API}/api/process-document`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await res.json();

                if (data.success) {
                    lastProcessedDoc = data.processed_content;
                    const stats = data.statistics;
                    
                    container.innerHTML = `
                        <div class="stats-grid" style="margin-top: 20px;">
                            <div class="stat-card">
                                <div class="stat-value">${stats.total_references}</div>
                                <div class="stat-label">Total References</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: var(--success);">${stats.processed}</div>
                                <div class="stat-label">Successfully Processed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: ${stats.failed > 0 ? 'var(--error)' : 'var(--text-muted)'};">${stats.failed}</div>
                                <div class="stat-label">Failed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.inline_replacements}</div>
                                <div class="stat-label">Inline Replacements</div>
                            </div>
                        </div>
                        ${data.failed_references && data.failed_references.length > 0 ? `
                            <div class="message error" style="margin-bottom: 16px;">
                                <span>‚ö†Ô∏è</span>
                                <span>Could not resolve: ${data.failed_references.map(r => `#${r.original_number}`).join(', ')}</span>
                            </div>
                        ` : ''}
                        <div class="result-box">
                            <div class="result-header">
                                <span class="result-label">Processed Document</span>
                            </div>
                            <div class="result-content">
                                <textarea readonly style="width: 100%; min-height: 400px; background: var(--bg-base); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 12px;">${escHtml(data.processed_content)}</textarea>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error || 'Processing failed')}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        function copyProcessedDoc() {
            if (lastProcessedDoc) {
                copyText(lastProcessedDoc);
            } else {
                showToast('No processed document to copy', 'error');
            }
        }

        function downloadProcessedDoc() {
            if (!lastProcessedDoc) {
                showToast('No processed document to download', 'error');
                return;
            }
            const blob = new Blob([lastProcessedDoc], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'processed_document.md';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Utilities
        function copyText(text) {
            navigator.clipboard.writeText(text);
            showToast('Copied to clipboard!');
        }

        function copyResult() {
            if (!lastResult || !lastResult.success) return;
            const format = document.getElementById('formatSelect').value;
            let text = '';
            if (format === 'inline') text = lastResult.inline_mark;
            else if (format === 'endnote') text = lastResult.full_citation;
            else text = lastResult.inline_mark + '\n\n' + lastResult.full_citation;
            copyText(text);
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'error' ? 'var(--error)' : 'var(--success)';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        function escHtml(text) {
            if (!text) return '';
            return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function esc(text) {
            if (!text) return '';
            return String(text).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/`/g, '\\`').replace(/\$/g, '\\$');
        }

        // =====================================================
        // Folder Browser for Vault Selection
        // =====================================================
        // Note: We use a server-side folder browser instead of the native 
        // File System Access API because:
        // 1. Native API doesn't expose full file paths (browser security)
        // 2. Safari/Firefox don't support showDirectoryPicker()
        // 3. Our server can provide full paths needed for configuration
        // =====================================================
        
        let currentBrowsePath = '';
        
        async function openFolderBrowser() {
            document.getElementById('folderBrowserModal').style.display = 'flex';
            await loadDirectory();
        }
        
        function closeFolderBrowser() {
            document.getElementById('folderBrowserModal').style.display = 'none';
        }
        
        async function loadDirectory(path = '') {
            const contentEl = document.getElementById('folderBrowserContent');
            const pathEl = document.getElementById('folderBrowserPath');
            const selectBtn = document.getElementById('selectFolderBtn');
            
            contentEl.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            
            try {
                const url = path 
                    ? `${API}/api/browse-directories?path=${encodeURIComponent(path)}`
                    : `${API}/api/browse-directories`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.error) {
                    contentEl.innerHTML = `<div class="message error"><span>‚ùå</span><span>${data.error}</span></div>`;
                    return;
                }
                
                currentBrowsePath = data.current;
                pathEl.textContent = data.current;
                
                // Enable select button if this is an Obsidian vault
                if (data.is_obsidian_vault) {
                    selectBtn.disabled = false;
                    selectBtn.innerHTML = '‚úì Select This Vault';
                    pathEl.innerHTML = `<span style="color: var(--accent);">üìö ${data.current}</span> <span style="background: var(--accent); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px;">Obsidian Vault</span>`;
                } else {
                    selectBtn.disabled = false;
                    selectBtn.innerHTML = '‚úì Select This Folder';
                }
                
                let html = '';
                
                // Parent directory navigation
                if (data.parent) {
                    html += `
                        <div class="folder-nav" onclick="loadDirectory('${escapeHtml(data.parent)}')">
                            <span class="icon">‚¨ÜÔ∏è</span>
                            <span>Go to parent folder</span>
                        </div>
                    `;
                }
                
                // List directories
                if (data.directories && data.directories.length > 0) {
                    for (const dir of data.directories) {
                        const vaultClass = dir.is_obsidian_vault ? 'vault' : '';
                        const badge = dir.is_obsidian_vault ? '<span class="badge">Vault</span>' : '';
                        const icon = dir.is_obsidian_vault ? 'üìö' : 'üìÅ';
                        
                        html += `
                            <div class="folder-item ${vaultClass}" onclick="loadDirectory('${escapeHtml(dir.path)}')">
                                <span class="icon">${icon}</span>
                                <span class="name">${escapeHtml(dir.name)}</span>
                                ${badge}
                            </div>
                        `;
                    }
                } else {
                    html += `
                        <div class="empty-folder">
                            <p>üì≠ No subdirectories</p>
                            <p style="font-size: 0.85rem;">You can still select this folder</p>
                        </div>
                    `;
                }
                
                contentEl.innerHTML = html;
                
            } catch (e) {
                contentEl.innerHTML = `<div class="message error"><span>‚ùå</span><span>Error: ${e.message}</span></div>`;
            }
        }
        
        function selectCurrentFolder() {
            if (currentBrowsePath) {
                document.getElementById('settingVaultPath').value = currentBrowsePath;
                closeFolderBrowser();
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, "\\'");
        }
        
        // Close modal when clicking outside
        document.getElementById('folderBrowserModal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeFolderBrowser();
            }
        });

        // =====================================================
        // Settings Page
        // =====================================================
        let settingsLoaded = false;

        async function loadSettings() {
            const loadingEl = document.getElementById('settingsContent');
            const formEl = document.getElementById('settingsForm');
            
            try {
                const res = await fetch(`${API}/api/settings`);
                const data = await res.json();
                
                if (data.settings) {
                    // Populate form fields
                    document.getElementById('settingVaultPath').value = data.settings.obsidian_vault_path || '';
                    document.getElementById('settingDefaultStyle').value = data.settings.default_citation_style || 'vancouver';
                    document.getElementById('settingCreateBackup').checked = data.settings.create_backup_on_process !== false;
                    document.getElementById('settingVerifyLinks').checked = data.settings.verify_links_by_default !== false;
                    document.getElementById('settingSuggestCitations').checked = data.settings.suggest_citations_by_default !== false;
                    document.getElementById('settingCheckCompliance').checked = data.settings.check_compliance_by_default !== false;
                    document.getElementById('settingEnableLLM').checked = data.settings.enable_llm_extraction !== false;
                    document.getElementById('settingMaxResults').value = data.settings.max_search_results || 10;
                    
                    // Show form, hide loading
                    loadingEl.style.display = 'none';
                    formEl.style.display = 'block';
                    settingsLoaded = true;
                }
            } catch (e) {
                loadingEl.innerHTML = `<div class="message error"><span>‚ùå</span><span>Failed to load settings: ${e.message}</span></div>`;
            }
        }

        async function saveSettings() {
            const msgEl = document.getElementById('settingsMessage');
            msgEl.innerHTML = '<div class="loading"><div class="spinner"></div>Saving...</div>';
            
            const settings = {
                obsidian_vault_path: document.getElementById('settingVaultPath').value.trim(),
                default_citation_style: document.getElementById('settingDefaultStyle').value,
                create_backup_on_process: document.getElementById('settingCreateBackup').checked,
                verify_links_by_default: document.getElementById('settingVerifyLinks').checked,
                suggest_citations_by_default: document.getElementById('settingSuggestCitations').checked,
                check_compliance_by_default: document.getElementById('settingCheckCompliance').checked,
                enable_llm_extraction: document.getElementById('settingEnableLLM').checked,
                max_search_results: parseInt(document.getElementById('settingMaxResults').value) || 10,
            };
            
            try {
                const res = await fetch(`${API}/api/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings),
                });
                const data = await res.json();
                
                if (data.success) {
                    msgEl.innerHTML = '<div class="message success"><span>‚úÖ</span><span>Settings saved! Changes will sync to Obsidian plugin on next Pull.</span></div>';
                    // Update vault hint on process page
                    loadVaultConfig();
                } else {
                    msgEl.innerHTML = `<div class="message error"><span>‚ùå</span><span>${data.error || 'Failed to save'}</span></div>`;
                }
            } catch (e) {
                msgEl.innerHTML = `<div class="message error"><span>‚ùå</span><span>Error: ${e.message}</span></div>`;
            }
            
            // Clear message after 6 seconds
            setTimeout(() => { msgEl.innerHTML = ''; }, 6000);
        }

        async function resetSettings() {
            if (!confirm('Are you sure you want to reset all settings to defaults?')) return;
            
            const msgEl = document.getElementById('settingsMessage');
            msgEl.innerHTML = '<div class="loading"><div class="spinner"></div>Resetting...</div>';
            
            try {
                const res = await fetch(`${API}/api/settings/reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });
                const data = await res.json();
                
                if (data.success) {
                    msgEl.innerHTML = '<div class="message success"><span>‚úÖ</span><span>Settings reset to defaults!</span></div>';
                    // Reload the form
                    settingsLoaded = false;
                    loadSettings();
                    loadVaultConfig();
                } else {
                    msgEl.innerHTML = `<div class="message error"><span>‚ùå</span><span>${data.error || 'Failed to reset'}</span></div>`;
                }
            } catch (e) {
                msgEl.innerHTML = `<div class="message error"><span>‚ùå</span><span>Error: ${e.message}</span></div>`;
            }
            
            setTimeout(() => { msgEl.innerHTML = ''; }, 5000);
        }

        // About Page
        let aboutLoaded = false;

        async function loadAbout() {
            if (aboutLoaded) return;
            
            const container = document.getElementById('aboutContent');
            
            try {
                const res = await fetch(`${API}/api/about`);
                const data = await res.json();
                
                if (data.content) {
                    const html = renderMarkdown(data.content);
                    container.innerHTML = `
                        <div class="about-quick-links">
                            <a href="#features">‚ú® Features</a>
                            <a href="#quick-start">üöÄ Quick Start</a>
                            <a href="#tools-overview">üìñ Tools</a>
                            <a href="#obsidian-plugin">üîå Obsidian Plugin</a>
                            <a href="#mcp-server">ü§ñ MCP Server</a>
                            <a href="https://github.com/shah0006/CitationSculptor" target="_blank">üì¶ GitHub</a>
                        </div>
                        <div class="markdown-content">${html}</div>
                    `;
                    aboutLoaded = true;
                } else {
                    container.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error || 'Could not load documentation')}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        function renderMarkdown(md) {
            // Process markdown into HTML
            let lines = md.split('\n');
            let html = [];
            let inCodeBlock = false;
            let codeContent = [];
            let codeLang = '';
            let inTable = false;
            let tableRows = [];
            let inList = false;
            let listItems = [];
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                
                // Code blocks
                if (line.startsWith('```')) {
                    if (inCodeBlock) {
                        html.push(`<pre><code class="language-${codeLang}">${escHtml(codeContent.join('\n'))}</code></pre>`);
                        codeContent = [];
                        codeLang = '';
                        inCodeBlock = false;
                    } else {
                        inCodeBlock = true;
                        codeLang = line.slice(3).trim();
                    }
                    continue;
                }
                
                if (inCodeBlock) {
                    codeContent.push(line);
                    continue;
                }
                
                // Tables
                if (line.startsWith('|') && line.endsWith('|')) {
                    const cells = line.split('|').filter(c => c.trim());
                    if (cells.every(c => /^[-:\s]+$/.test(c))) {
                        continue; // Skip separator row
                    }
                    if (!inTable) {
                        inTable = true;
                        tableRows = [];
                    }
                    tableRows.push(cells.map(c => c.trim()));
                    continue;
                } else if (inTable) {
                    // End table
                    let tableHtml = '<table>';
                    tableRows.forEach((row, idx) => {
                        const tag = idx === 0 ? 'th' : 'td';
                        tableHtml += '<tr>' + row.map(c => `<${tag}>${processInline(c)}</${tag}>`).join('') + '</tr>';
                    });
                    tableHtml += '</table>';
                    html.push(tableHtml);
                    inTable = false;
                    tableRows = [];
                }
                
                // Lists
                if (line.match(/^[-*] .+/) || line.match(/^\d+\. .+/)) {
                    const content = line.replace(/^[-*]\s+/, '').replace(/^\d+\.\s+/, '');
                    if (!inList) {
                        inList = true;
                        listItems = [];
                    }
                    listItems.push(processInline(content));
                    continue;
                } else if (inList && line.trim() === '') {
                    html.push('<ul>' + listItems.map(li => `<li>${li}</li>`).join('') + '</ul>');
                    inList = false;
                    listItems = [];
                    continue;
                } else if (inList) {
                    html.push('<ul>' + listItems.map(li => `<li>${li}</li>`).join('') + '</ul>');
                    inList = false;
                    listItems = [];
                }
                
                // Skip empty lines (we'll handle spacing via CSS)
                if (line.trim() === '') continue;
                
                // Horizontal rules
                if (line.match(/^---+$/)) {
                    html.push('<hr>');
                    continue;
                }
                
                // Headers
                if (line.startsWith('#### ')) {
                    html.push(`<h4>${processInline(line.slice(5))}</h4>`);
                    continue;
                }
                if (line.startsWith('### ')) {
                    html.push(`<h3>${processInline(line.slice(4))}</h3>`);
                    continue;
                }
                if (line.startsWith('## ')) {
                    const title = line.slice(3);
                    const id = title.toLowerCase().replace(/[^\w]+/g, '-').replace(/^-|-$/g, '');
                    html.push(`<h2 id="${id}">${processInline(title)}</h2>`);
                    continue;
                }
                if (line.startsWith('# ')) {
                    html.push(`<h1>${processInline(line.slice(2))}</h1>`);
                    continue;
                }
                
                // Blockquotes
                if (line.startsWith('> ')) {
                    html.push(`<blockquote>${processInline(line.slice(2))}</blockquote>`);
                    continue;
                }
                
                // Regular paragraph
                html.push(`<p>${processInline(line)}</p>`);
            }
            
            // Close any remaining open blocks
            if (inList) {
                html.push('<ul>' + listItems.map(li => `<li>${li}</li>`).join('') + '</ul>');
            }
            if (inTable) {
                let tableHtml = '<table>';
                tableRows.forEach((row, idx) => {
                    const tag = idx === 0 ? 'th' : 'td';
                    tableHtml += '<tr>' + row.map(c => `<${tag}>${processInline(c)}</${tag}>`).join('') + '</tr>';
                });
                tableHtml += '</table>';
                html.push(tableHtml);
            }
            
            return html.join('\n');
        }
        
        function processInline(text) {
            // Process inline markdown elements
            let result = text;
            
            // Images first (before links)
            result = result.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">');
            
            // Links
            result = result.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // Bold + italic
            result = result.replace(/\*\*\*([^*]+)\*\*\*/g, '<strong><em>$1</em></strong>');
            
            // Bold
            result = result.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Italic
            result = result.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // Inline code
            result = result.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            return result;
        }

        // Init
        checkServer();
        setInterval(checkServer, 30000);

        // Load library when that page is opened
        document.querySelector('[data-page="library"]').addEventListener('click', loadLibrary);

        // Load settings when that page is opened
        document.querySelector('[data-page="settings"]').addEventListener('click', loadSettings);

        // Load about when that page is opened
        document.querySelector('[data-page="about"]').addEventListener('click', loadAbout);
        
        // Load vault configuration on page load
        async function loadVaultConfig() {
            try {
                const res = await fetch(`${API}/api/config/vault`);
                const data = await res.json();
                const hintEl = document.getElementById('vault-hint-text');
                if (data.configured && data.path) {
                    hintEl.innerHTML = `Vault: <code>${data.path}</code> ‚Äî relative paths are supported`;
                } else {
                    hintEl.innerHTML = `Set <code>OBSIDIAN_VAULT_PATH</code> in <code>.env</code> file to use relative paths, or use absolute paths`;
                }
            } catch (e) {
                const hintEl = document.getElementById('vault-hint-text');
                hintEl.textContent = 'Use absolute paths (server not reachable for config)';
            }
        }
        loadVaultConfig();
    </script>
</body>
</html>
