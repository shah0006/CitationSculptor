<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CitationSculptor v2.4.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-base: #09090b;
            --bg-surface: #18181b;
            --bg-elevated: #27272a;
            --bg-hover: #3f3f46;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent: #8b5cf6;
            --accent-hover: #a78bfa;
            --accent-muted: rgba(139, 92, 246, 0.15);
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
            --border: #27272a;
            --border-hover: #3f3f46;
            --radius: 8px;
            --radius-lg: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Layout */
        .app {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 20px 24px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent) 0%, #c084fc 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo h1 {
            font-size: 1.25rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent) 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-version {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .nav-section {
            padding: 0 12px;
            margin-bottom: 20px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px;
            margin-bottom: 4px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: var(--radius);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 14px;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            font-family: inherit;
        }

        .nav-item:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent-muted);
            color: var(--accent);
        }

        .nav-item-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .status-badge {
            margin-left: auto;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
        }

        .status-badge.online {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .status-badge.offline {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }

        /* Main Content */
        .main {
            flex: 1;
            margin-left: 260px;
            padding: 32px 40px;
            max-width: 1000px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Cards */
        .card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        input[type="text"],
        input[type="file"],
        textarea,
        select {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-muted);
        }

        input::placeholder,
        textarea::placeholder {
            color: var(--text-muted);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        select {
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn:hover {
            background: var(--accent-hover);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        /* Results */
        .result-box {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin-top: 20px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-base);
            border-bottom: 1px solid var(--border);
        }

        .result-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .result-content {
            padding: 16px;
        }

        .result-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-primary);
            user-select: all;
        }

        .result-text.inline {
            color: var(--accent);
        }

        /* Search Results */
        .search-results {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .search-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            transition: all 0.15s ease;
        }

        .search-item:hover {
            border-color: var(--border-hover);
        }

        .search-item-title {
            font-weight: 500;
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .search-item-meta {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .search-item-ids {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .id-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            padding: 4px 8px;
            background: var(--bg-base);
            border-radius: 4px;
            color: var(--text-secondary);
        }

        /* Library */
        .library-grid {
            display: grid;
            gap: 16px;
        }

        .citation-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
        }

        .citation-title {
            font-weight: 500;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .citation-meta {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .citation-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .tag {
            font-size: 11px;
            padding: 3px 8px;
            background: var(--accent-muted);
            color: var(--accent);
            border-radius: 12px;
        }

        /* File Upload */
        .file-drop {
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .file-drop:hover,
        .file-drop.dragover {
            border-color: var(--accent);
            background: var(--accent-muted);
        }

        .file-drop-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .file-drop-text {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .file-drop-hint {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-base);
            padding: 4px;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }

        .tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--accent);
            color: white;
        }

        /* Messages */
        .message {
            padding: 14px 16px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .message.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .message.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .message.info {
            background: var(--accent-muted);
            border: 1px solid rgba(139, 92, 246, 0.2);
            color: var(--accent);
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 24px;
            background: var(--success);
            color: white;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* About/Documentation Styles */
        .markdown-content {
            line-height: 1.5;
            font-size: 13px;
        }

        .markdown-content h1 {
            font-size: 1.5rem;
            margin: 20px 0 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
            color: var(--accent);
        }

        .markdown-content h1:first-child {
            margin-top: 0;
        }

        .markdown-content h2 {
            font-size: 1.2rem;
            margin: 18px 0 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }

        .markdown-content h3 {
            font-size: 1rem;
            margin: 14px 0 4px;
            color: var(--text-primary);
        }

        .markdown-content h4 {
            font-size: 0.9rem;
            margin: 10px 0 4px;
            color: var(--text-secondary);
        }

        .markdown-content p {
            margin: 6px 0;
        }

        .markdown-content ul, .markdown-content ol {
            margin: 6px 0;
            padding-left: 20px;
        }

        .markdown-content li {
            margin: 2px 0;
        }

        .markdown-content code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            padding: 1px 5px;
            background: var(--bg-base);
            border-radius: 3px;
            color: var(--accent);
        }

        .markdown-content pre {
            background: var(--bg-base);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px 12px;
            overflow-x: auto;
            margin: 8px 0;
            font-size: 12px;
            line-height: 1.4;
        }

        .markdown-content pre code {
            padding: 0;
            background: transparent;
            color: var(--text-primary);
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 12px;
        }

        .markdown-content th, .markdown-content td {
            padding: 6px 10px;
            text-align: left;
            border: 1px solid var(--border);
        }

        .markdown-content th {
            background: var(--bg-base);
            font-weight: 600;
        }

        .markdown-content tr:nth-child(even) {
            background: rgba(255,255,255,0.02);
        }

        .markdown-content blockquote {
            margin: 8px 0;
            padding: 8px 12px;
            border-left: 3px solid var(--accent);
            background: var(--accent-muted);
            border-radius: 0 var(--radius) var(--radius) 0;
            font-size: 12px;
        }

        .markdown-content a {
            color: var(--accent);
            text-decoration: none;
        }

        .markdown-content a:hover {
            text-decoration: underline;
        }

        .markdown-content hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 16px 0;
        }

        .markdown-content img {
            max-width: 100%;
            border-radius: var(--radius);
            height: 20px;
            vertical-align: middle;
        }

        /* Quick links at top of about page */
        .about-quick-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .about-quick-links a {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 5px 10px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-secondary);
            font-size: 12px;
            text-decoration: none;
            transition: all 0.15s ease;
        }

        .about-quick-links a:hover {
            background: var(--accent-muted);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Compact card for about page */
        #aboutContent.card {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .sidebar {
                width: 200px;
            }
            .main {
                margin-left: 200px;
                padding: 24px;
            }
        }

        @media (max-width: 700px) {
            .sidebar {
                position: static;
                width: 100%;
                height: auto;
            }
            .main {
                margin-left: 0;
            }
            .app {
                flex-direction: column;
            }
            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">üìö</div>
                <div>
                    <h1>CitationSculptor</h1>
                    <div class="logo-version">v2.4.0</div>
                </div>
            </div>

            <nav class="nav-section">
                <div class="nav-section-title">Citation Tools</div>
                <button type="button" class="nav-item active" data-page="lookup">
                    <span class="nav-item-icon">üîç</span>
                    Quick Lookup
                </button>
                <button type="button" class="nav-item" data-page="search">
                    <span class="nav-item-icon">üìö</span>
                    Search
                </button>
                <button type="button" class="nav-item" data-page="batch">
                    <span class="nav-item-icon">üìã</span>
                    Batch Process
                </button>
                <button type="button" class="nav-item" data-page="document">
                    <span class="nav-item-icon">üìù</span>
                    Process Document
                </button>
                <button type="button" class="nav-item" data-page="pdf">
                    <span class="nav-item-icon">üìÑ</span>
                    PDF Extract
                </button>
                <button type="button" class="nav-item" data-page="recent">
                    <span class="nav-item-icon">üïê</span>
                    Recent Lookups
                </button>
                <button type="button" class="nav-item" data-page="corrections">
                    <span class="nav-item-icon">üîß</span>
                    Corrections
                </button>
                <button type="button" class="nav-item" data-page="normalize">
                    <span class="nav-item-icon">‚ú®</span>
                    Normalize
                </button>
            </nav>

            <nav class="nav-section">
                <div class="nav-section-title">Library</div>
                <button type="button" class="nav-item" data-page="library">
                    <span class="nav-item-icon">üóÉÔ∏è</span>
                    My Citations
                </button>
                <button type="button" class="nav-item" data-page="bibliography">
                    <span class="nav-item-icon">üìù</span>
                    Bibliography
                </button>
                <button type="button" class="nav-item" data-page="article-duplicates">
                    <span class="nav-item-icon">üßπ</span>
                    Library Hygiene
                </button>
            </nav>

            <nav class="nav-section">
                <div class="nav-section-title">Import / Export</div>
                <button type="button" class="nav-item" data-page="import">
                    <span class="nav-item-icon">üì•</span>
                    Import
                </button>
                <button type="button" class="nav-item" data-page="export">
                    <span class="nav-item-icon">üì§</span>
                    Export
                </button>
            </nav>

            <nav class="nav-section">
                <div class="nav-section-title">Document Intelligence</div>
                <button type="button" class="nav-item" data-page="verify-links">
                    <span class="nav-item-icon">üîó</span>
                    Verify Links
                </button>
                <button type="button" class="nav-item" data-page="suggest-citations">
                    <span class="nav-item-icon">üí°</span>
                    Suggest Citations
                </button>
                <button type="button" class="nav-item" data-page="check-compliance">
                    <span class="nav-item-icon">‚úÖ</span>
                    Check Compliance
                </button>
                <button type="button" class="nav-item" data-page="find-duplicates">
                    <span class="nav-item-icon">üîç</span>
                    Find Duplicates
                </button>
                <button type="button" class="nav-item" data-page="verify-context">
                    <span class="nav-item-icon">üéØ</span>
                    Verify Context
                </button>
                <button type="button" class="nav-item" data-page="audit">
                    <span class="nav-item-icon">üìä</span>
                    Full Audit
                </button>
            </nav>

            <nav class="nav-section">
                <div class="nav-section-title">System</div>
                <button type="button" class="nav-item" data-page="settings">
                    <span class="nav-item-icon">‚öôÔ∏è</span>
                    Settings
                </button>
                <button type="button" class="nav-item" data-page="about">
                    <span class="nav-item-icon">‚ÑπÔ∏è</span>
                    About
                </button>
            </nav>

            <nav class="nav-section" style="margin-top: auto;">
                <div class="nav-item">
                    <span class="nav-item-icon">‚ö°</span>
                    Server
                    <span class="status-badge" id="serverStatus">...</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Quick Lookup Page -->
            <div class="page active" id="lookup">
                <div class="page-header">
                    <h2 class="page-title">Quick Lookup</h2>
                    <p class="page-subtitle">Enter any identifier: PMID, DOI, PMC ID, arXiv ID, ISBN, or article title</p>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Identifier</label>
                        <input type="text" id="lookupInput" placeholder="e.g., 37622666, 10.1093/eurheartj/ehad195, arXiv:2301.00001, 978-0-123456-78-9">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Citation Style</label>
                            <select id="styleSelect">
                                <option value="vancouver">Vancouver</option>
                                <option value="apa">APA 7th</option>
                                <option value="mla">MLA 9th</option>
                                <option value="chicago">Chicago</option>
                                <option value="harvard">Harvard</option>
                                <option value="ieee">IEEE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Format</label>
                            <select id="formatSelect">
                                <option value="full">Full Citation</option>
                                <option value="inline">Inline Only</option>
                                <option value="endnote">Endnote Only</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="doLookup()">üîç Look Up</button>
                        <button class="btn btn-secondary" onclick="copyResult()">üìã Copy</button>
                        <button class="btn btn-secondary" onclick="saveCitation()">üíæ Save</button>
                    </div>
                    <div id="lookupResult"></div>
                </div>
            </div>

            <!-- Search Page -->
            <div class="page" id="search">
                <div class="page-header">
                    <h2 class="page-title">Search</h2>
                    <p class="page-subtitle">Search across PubMed, OpenAlex, and Semantic Scholar</p>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Search Query</label>
                        <input type="text" id="searchInput" placeholder="e.g., heart failure guidelines 2023">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Source</label>
                            <select id="searchSource">
                                <option value="pubmed">PubMed</option>
                                <option value="openalex">OpenAlex</option>
                                <option value="semantic_scholar">Semantic Scholar</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Max Results</label>
                            <select id="searchMax">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="doSearch()">üîé Search</button>
                    <div id="searchResults"></div>
                </div>
            </div>

            <!-- Batch Page -->
            <div class="page" id="batch">
                <div class="page-header">
                    <h2 class="page-title">Batch Process</h2>
                    <p class="page-subtitle">Process multiple identifiers at once</p>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Enter identifiers (one per line)</label>
                        <textarea id="batchInput" placeholder="37622666&#10;10.1093/eurheartj/ehad195&#10;PMC7039045"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Citation Style</label>
                            <select id="batchStyle">
                                <option value="vancouver">Vancouver</option>
                                <option value="apa">APA 7th</option>
                                <option value="mla">MLA 9th</option>
                                <option value="chicago">Chicago</option>
                                <option value="harvard">Harvard</option>
                                <option value="ieee">IEEE</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="doBatch()">üìã Process Batch</button>
                        <button class="btn btn-secondary" onclick="copyBatchResult()">üìã Copy All</button>
                    </div>
                    <div id="batchResults"></div>
                </div>
            </div>

            <!-- Process Document Page -->
            <div class="page" id="document">
                <div class="page-header">
                    <h2 class="page-title">Process Document</h2>
                    <p class="page-subtitle">Process a markdown document, looking up all citations and updating inline references</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchDocTab('content')">Paste Content</button>
                    <button class="tab" onclick="switchDocTab('file')">File Path</button>
                </div>

                <div class="card">
                    <div id="docContentTab">
                        <div class="form-group">
                            <label class="form-label">Paste your Markdown document content</label>
                            <textarea id="docContent" placeholder="# My Document&#10;&#10;This study shows that... [1]&#10;&#10;## References&#10;&#10;1. Smith J, et al. Important findings. J Medicine. 2024;1:2-3. https://pubmed.ncbi.nlm.nih.gov/12345678/" style="min-height: 250px;"></textarea>
                        </div>
                    </div>
                    <div id="docFileTab" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Enter the path to your Markdown file</label>
                            <input type="text" id="docFilePath" placeholder="/Users/you/Documents/my-document.md">
                        </div>
                        <div class="message info" style="margin-top: 12px;" id="vault-path-hint">
                            <span>üí°</span>
                            <span id="vault-hint-text">Loading vault configuration...</span>
                        </div>
                    </div>
                    <div class="form-row" style="margin-top: 16px;">
                        <div class="form-group">
                            <label class="form-label">Citation Style</label>
                            <select id="docStyle">
                                <option value="vancouver">Vancouver</option>
                                <option value="apa">APA 7th</option>
                                <option value="mla">MLA 9th</option>
                                <option value="chicago">Chicago</option>
                                <option value="harvard">Harvard</option>
                                <option value="ieee">IEEE</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Processing Options -->
                    <div style="margin: 16px 0; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">Processing Options</div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <input type="checkbox" id="dryRun" style="width: 18px; height: 18px;">
                                <span><strong>üëÅÔ∏è Dry Run (Preview)</strong> ‚Äî Show what would change without saving</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <input type="checkbox" id="multiSection" style="width: 18px; height: 18px;">
                                <span><strong>üìë Multi-Section Mode</strong> ‚Äî Process documents with multiple reference sections independently</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <input type="checkbox" id="processOrphans" style="width: 18px; height: 18px;">
                                <span><strong>üîó Process Orphaned References</strong> ‚Äî Format references not cited in document body (kept in separate section)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="saveOptionsRow" style="margin: 16px 0; padding: 12px; background: var(--bg-secondary); border-radius: 8px; display: none;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="saveToFile" style="width: 18px; height: 18px;">
                            <span><strong>üíæ Save to original file</strong> ‚Äî Overwrites the file with processed content (backup created automatically)</span>
                        </label>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn" onclick="processDocument()">‚öôÔ∏è Process Document</button>
                        <button class="btn btn-secondary" onclick="copyProcessedDoc()">üìã Copy Result</button>
                        <button class="btn btn-secondary" onclick="downloadProcessedDoc()">üíæ Download</button>
                    </div>
                    <div id="docResult"></div>
                </div>
            </div>

            <!-- PDF Extract Page -->
            <div class="page" id="pdf">
                <div class="page-header">
                    <h2 class="page-title">PDF Extraction</h2>
                    <p class="page-subtitle">Extract citation metadata from PDF files</p>
                </div>

                <div class="card">
                    <div class="file-drop" id="pdfDrop" onclick="document.getElementById('pdfFile').click()">
                        <div class="file-drop-icon">üìÑ</div>
                        <div class="file-drop-text">Drop PDF here or click to upload</div>
                        <div class="file-drop-hint">Extracts DOI, PMID, arXiv ID, title, and authors</div>
                        <input type="file" id="pdfFile" accept=".pdf" style="display: none" onchange="handlePdfUpload(event)">
                    </div>
                    <div id="pdfResult"></div>
                </div>

                <div class="message info">
                    <span>üí°</span>
                    PDF extraction requires PyMuPDF. Install with: <code>pip install PyMuPDF</code>
                </div>
            </div>

            <!-- Recent Lookups Page -->
            <div class="page" id="recent">
                <div class="page-header">
                    <h2 class="page-title">Recent Lookups</h2>
                    <p class="page-subtitle">Your recent citation lookups (stored locally)</p>
                </div>

                <div class="card">
                    <div class="form-row" style="justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <span id="recentCount" style="color: var(--text-muted);">0 recent lookups</span>
                        <button class="btn btn-secondary" onclick="clearRecentLookups()">üóëÔ∏è Clear History</button>
                    </div>
                    <div id="recentList" style="display: flex; flex-direction: column; gap: 12px;">
                        <div class="message info">
                            <span>üí°</span>
                            <span>No recent lookups yet. Use Quick Lookup or Search to find citations.</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Corrections Page -->
            <div class="page" id="corrections">
                <div class="page-header">
                    <h2 class="page-title">Citation Corrections</h2>
                    <p class="page-subtitle">Fix citations with missing information (Null_Date, Null_Author, etc.)</p>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">1. Paste processed document content</label>
                        <textarea id="correctionsInput" placeholder="Paste your processed document here to find citations needing corrections..." style="min-height: 200px;"></textarea>
                    </div>
                    <button class="btn" onclick="generateCorrections()">üîç Find Citations Needing Corrections</button>
                    <div id="correctionsResult" style="margin-top: 16px;"></div>
                </div>

                <div class="card" id="correctionsEditCard" style="display: none;">
                    <h3 style="margin-bottom: 16px; color: var(--accent);">üìù Edit Corrections</h3>
                    <div id="correctionsEditList"></div>
                    <div class="btn-group" style="margin-top: 16px;">
                        <button class="btn" onclick="applyCorrections()">‚úÖ Apply Corrections</button>
                        <button class="btn btn-secondary" onclick="downloadCorrections()">üì• Download Template</button>
                    </div>
                </div>

                <div class="message info" style="margin-top: 16px;">
                    <span>üí°</span>
                    <div>
                        <strong>Workflow:</strong>
                        <ol style="margin: 8px 0 0 20px; padding: 0;">
                            <li>Process a document to identify citations</li>
                            <li>Paste the result here to find citations with missing data</li>
                            <li>Fill in the missing information for each citation</li>
                            <li>Apply corrections to get the fixed document</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- Normalize Page -->
            <div class="page" id="normalize">
                <div class="page-header">
                    <h2 class="page-title">Normalize Citations</h2>
                    <p class="page-subtitle">Convert legacy citation formats to Obsidian footnote style</p>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Citation Content</label>
                        <p class="page-subtitle" style="margin-bottom: 12px;">Paste citations to normalize. Converts [1], [1,2], [6-10] ‚Üí [^1], [^1][^2], [^6][^7]...</p>
                        <textarea id="normalizeInput" placeholder="Paste citation text or content with legacy citation formats...

Examples of formats that will be normalized:
‚Ä¢ [1] ‚Üí [^1]
‚Ä¢ [1, 2, 3] ‚Üí [^1] [^2] [^3]
‚Ä¢ [6-10] ‚Üí [^6] [^7] [^8] [^9] [^10]
‚Ä¢ According to studies [1-3, 7]... ‚Üí According to studies [^1] [^2] [^3] [^7]..." style="min-height: 200px;"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="normalizeDryRun" checked>
                                <span>Preview only (don't modify)</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="doNormalize()">‚ú® Normalize Citations</button>
                        <button class="btn btn-secondary" onclick="clearNormalize()">Clear</button>
                    </div>
                </div>

                <div id="normalizeResult" class="result-card" style="display: none;">
                    <div class="result-header">
                        <span class="result-badge result-badge-success">Normalized</span>
                    </div>
                    <div class="result-body">
                        <pre id="normalizeOutput" style="white-space: pre-wrap; font-family: 'JetBrains Mono', monospace;"></pre>
                    </div>
                    <div class="result-actions">
                        <button class="btn btn-sm" onclick="copyNormalizeResult()">üìã Copy Result</button>
                    </div>
                </div>
            </div>

            <!-- Library Page -->
            <div class="page" id="library">
                <div class="page-header">
                    <h2 class="page-title">My Citations</h2>
                    <p class="page-subtitle">Your saved citation library with full-text search</p>
                </div>

                <div class="card">
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="librarySearch" placeholder="Search your citations...">
                        </div>
                        <button class="btn" onclick="searchLibrary()">üîç Search</button>
                        <button class="btn btn-secondary" onclick="loadLibrary()">‚Üª Refresh</button>
                    </div>
                </div>

                <div class="stats-grid" id="libraryStats">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotal">-</div>
                        <div class="stat-label">Total Citations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statTags">-</div>
                        <div class="stat-label">Tags</div>
                    </div>
                </div>

                <div id="libraryResults">
                    <div class="empty-state">
                        <div class="empty-state-icon">üóÉÔ∏è</div>
                        <p>Your citation library is empty</p>
                        <p style="font-size: 13px; margin-top: 8px;">Save citations from the Quick Lookup page</p>
                    </div>
                </div>
            </div>

            <!-- Bibliography Page -->
            <div class="page" id="bibliography">
                <div class="page-header">
                    <h2 class="page-title">Bibliography Generator</h2>
                    <p class="page-subtitle">Generate formatted bibliographies from identifiers</p>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Enter identifiers (one per line)</label>
                        <textarea id="bibInput" placeholder="Enter PMIDs, DOIs, or other identifiers..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Citation Style</label>
                            <select id="bibStyle">
                                <option value="vancouver">Vancouver</option>
                                <option value="apa">APA 7th</option>
                                <option value="mla">MLA 9th</option>
                                <option value="chicago">Chicago</option>
                                <option value="harvard">Harvard</option>
                                <option value="ieee">IEEE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sort Order</label>
                            <select id="bibSort">
                                <option value="alphabetical">Alphabetical</option>
                                <option value="appearance">Order of Appearance</option>
                                <option value="year">By Year (newest first)</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="generateBibliography()">üìù Generate</button>
                        <button class="btn btn-secondary" onclick="copyBibliography()">üìã Copy</button>
                    </div>
                    <div id="bibResult"></div>
                </div>
            </div>

            <!-- Library Hygiene / Article Duplicates Page -->
            <div class="page" id="article-duplicates">
                <div class="page-header">
                    <h2 class="page-title">Library Hygiene</h2>
                    <p class="page-subtitle">Check bibliography or library for duplicate articles (same paper cited multiple times)</p>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Citation Identifiers or Bibliography</label>
                        <p class="page-subtitle" style="margin-bottom: 12px;">Enter PMIDs, DOIs, or paste a bibliography to check for duplicate papers</p>
                        <textarea id="articleDuplicatesInput" placeholder="Enter one identifier per line (PMID, DOI, etc.) or paste a bibliography:

32089132
10.1186/s12968-020-00607-1
PMC7039045
..." style="min-height: 200px;"></textarea>
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="doCheckArticleDuplicates()">üßπ Check for Duplicates</button>
                        <button class="btn btn-secondary" onclick="clearArticleDuplicates()">Clear</button>
                    </div>
                </div>

                <div id="articleDuplicatesResult" class="result-card" style="display: none;">
                    <div class="result-header">
                        <span class="result-badge" id="articleDuplicatesBadge">Results</span>
                    </div>
                    <div class="result-body">
                        <div id="articleDuplicatesOutput"></div>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px; background: var(--bg-elevated);">
                    <h3 style="margin-bottom: 8px; font-size: 14px;">About Library Hygiene</h3>
                    <p class="page-subtitle" style="margin: 0;">
                        This tool detects when the <strong>same academic article</strong> appears multiple times in your bibliography 
                        (e.g., once by PMID and once by DOI). This is different from "Find Duplicates" which detects 
                        consecutive identical citation tags like [^A][^A] in document text.
                    </p>
                </div>
            </div>

            <!-- Import Page -->
            <div class="page" id="import">
                <div class="page-header">
                    <h2 class="page-title">Import Citations</h2>
                    <p class="page-subtitle">Import from BibTeX or RIS format</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchImportTab('bibtex')">BibTeX</button>
                    <button class="tab" onclick="switchImportTab('ris')">RIS</button>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label" id="importLabel">Paste BibTeX content</label>
                        <textarea id="importInput" placeholder="@article{...}"></textarea>
                    </div>
                    <button class="btn" onclick="doImport()">üì• Import</button>
                    <div id="importResult"></div>
                </div>
            </div>

            <!-- Export Page -->
            <div class="page" id="export">
                <div class="page-header">
                    <h2 class="page-title">Export Citations</h2>
                    <p class="page-subtitle">Export your library to BibTeX or RIS format</p>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Select citations to export (by ID, comma-separated)</label>
                        <input type="text" id="exportIds" placeholder="e.g., 1, 2, 3 (leave empty for all)">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Export Format</label>
                            <select id="exportFormat">
                                <option value="bibtex">BibTeX (.bib)</option>
                                <option value="ris">RIS (.ris)</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="doExport()">üì§ Export</button>
                </div>
            </div>

            <!-- Settings Page -->
            <div class="page" id="settings">
                <div class="page-header">
                    <h2 class="page-title">‚öôÔ∏è Settings</h2>
                    <p class="page-subtitle">Configure CitationSculptor preferences</p>
                </div>

                <div class="card" style="background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%); color: white; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <span style="font-size: 2rem;">üîÑ</span>
                        <div>
                            <h3 style="margin: 0 0 4px 0; color: white;">Bidirectional Settings Sync</h3>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">
                                <strong>Settings sync automatically</strong> between this Web UI and the Obsidian plugin.
                                Changes made here appear in Obsidian within seconds, and vice versa.
                                Synced: Citation Style, Backup Preference, Max Search Results.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="card" id="settingsContent">
                    <div class="loading"><div class="spinner"></div>Loading settings...</div>
                </div>
                
                <div class="card" id="settingsForm" style="display: none;">
                    <h3 style="margin-bottom: 20px; color: var(--accent);">üìÅ Obsidian Vault</h3>
                    
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label class="form-label">Obsidian Vault Path</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" class="form-input" id="settingVaultPath" 
                                   placeholder="/path/to/your/obsidian/vault" style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="openFolderBrowser()" style="white-space: nowrap;">
                                üìÇ Browse...
                            </button>
                        </div>
                        <div class="message info" style="margin-top: 8px;">
                            <span>üí°</span>
                            <span>Set this to use relative paths when processing documents</span>
                        </div>
                    </div>

                    <h3 style="margin-bottom: 20px; color: var(--accent);">üìù Citation Defaults</h3>
                    
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label class="form-label">Default Citation Style</label>
                        <select class="form-select" id="settingDefaultStyle">
                            <option value="vancouver">Vancouver (Medical)</option>
                            <option value="apa">APA 7th Edition</option>
                            <option value="mla">MLA 9th Edition</option>
                            <option value="chicago">Chicago/Turabian</option>
                            <option value="harvard">Harvard</option>
                            <option value="ieee">IEEE</option>
                        </select>
                    </div>

                    <h3 style="margin-bottom: 20px; color: var(--accent);">üõ°Ô∏è Safety Features</h3>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="settingCreateBackup" style="width: 18px; height: 18px;">
                            <span>Create backup before processing documents</span>
                        </label>
                    </div>

                    <h3 style="margin-bottom: 20px; color: var(--accent);">üß† Document Intelligence</h3>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="settingVerifyLinks" style="width: 18px; height: 18px;">
                            <span>Verify links by default when analyzing documents</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="settingSuggestCitations" style="width: 18px; height: 18px;">
                            <span>Suggest citations by default</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="settingCheckCompliance" style="width: 18px; height: 18px;">
                            <span>Check citation compliance by default</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="settingEnableLLM" style="width: 18px; height: 18px;">
                            <span>Enable LLM-powered metadata extraction (requires Ollama)</span>
                        </label>
                    </div>

                    <h3 style="margin-bottom: 20px; color: var(--accent);">üîç Search</h3>
                    
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label class="form-label">Maximum Search Results</label>
                        <input type="number" class="form-input" id="settingMaxResults" 
                               min="5" max="50" value="10" style="width: 100px;">
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 32px; padding-top: 20px; border-top: 1px solid var(--border);">
                        <button type="button" class="btn btn-primary" onclick="saveSettings()">
                            üíæ Save Settings
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetSettings()">
                            üîÑ Reset to Defaults
                        </button>
                    </div>
                    
                    <div id="settingsMessage" style="margin-top: 16px;"></div>
                </div>
            </div>

            <!-- Verify Links Page -->
            <div class="page" id="verify-links">
                <div class="page-header">
                    <h2 class="page-title">üîó Verify Links</h2>
                    <p class="page-subtitle">Check URLs in your document for broken links, redirects, and archived versions</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchVerifyLinksTab('content')">Paste Content</button>
                    <button class="tab" onclick="switchVerifyLinksTab('file')">File Path</button>
                    <button class="tab" onclick="switchVerifyLinksTab('urls')">URLs Only</button>
                </div>

                <div class="card">
                    <div id="verifyLinksContentTab">
                        <div class="form-group">
                            <label class="form-label">Paste your document content</label>
                            <textarea id="verifyLinksInput" rows="6" placeholder="Paste document content with URLs to verify..."></textarea>
                        </div>
                    </div>
                    <div id="verifyLinksFileTab" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Enter the path to your file</label>
                            <input type="text" id="verifyLinksFilePath" placeholder="/Users/you/Documents/my-document.md">
                        </div>
                    </div>
                    <div id="verifyLinksUrlsTab" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Enter URLs directly (one per line)</label>
                            <textarea id="verifyLinksUrls" rows="6" placeholder="https://example.com/article1&#10;https://example.com/article2"></textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn" onclick="verifyLinks()">üîó Verify Links</button>
                    </div>
                </div>

                <div class="card" id="verifyLinksResult" style="display: none;">
                    <h3>Verification Results</h3>
                    <div id="verifyLinksContent"></div>
                </div>
            </div>

            <!-- Suggest Citations Page -->
            <div class="page" id="suggest-citations">
                <div class="page-header">
                    <h2 class="page-title">üí° Suggest Citations</h2>
                    <p class="page-subtitle">Find passages that may need citations (statistics, claims, research findings)</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchSuggestTab('content')">Paste Content</button>
                    <button class="tab" onclick="switchSuggestTab('file')">File Path</button>
                </div>

                <div class="card">
                    <div id="suggestContentTab">
                        <div class="form-group">
                            <label class="form-label">Paste your document content</label>
                            <textarea id="suggestCitationsInput" rows="8" placeholder="Paste document content to analyze for missing citations..."></textarea>
                        </div>
                    </div>
                    <div id="suggestFileTab" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Enter the path to your file</label>
                            <input type="text" id="suggestFilePath" placeholder="/Users/you/Documents/my-document.md">
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="searchPubMedSuggestions" style="width: 18px; height: 18px;">
                            <span>Search PubMed for suggested citations (slower but more helpful)</span>
                        </label>
                    </div>
                    <div class="form-actions">
                        <button class="btn" onclick="suggestCitations()">üí° Find Citation Opportunities</button>
                    </div>
                </div>

                <div class="card" id="suggestCitationsResult" style="display: none;">
                    <h3>Suggested Citations</h3>
                    <div id="suggestCitationsContent"></div>
                </div>
            </div>

            <!-- Check Compliance Page -->
            <div class="page" id="check-compliance">
                <div class="page-header">
                    <h2 class="page-title">‚úÖ Check Compliance</h2>
                    <p class="page-subtitle">Find uncited quotes, claims without evidence, and academic phrases that need sources</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchComplianceTab('content')">Paste Content</button>
                    <button class="tab" onclick="switchComplianceTab('file')">File Path</button>
                </div>

                <div class="card">
                    <div id="complianceContentTab">
                        <div class="form-group">
                            <label class="form-label">Paste your document content</label>
                            <textarea id="checkComplianceInput" rows="8" placeholder="Paste document content to check for citation compliance issues..."></textarea>
                        </div>
                    </div>
                    <div id="complianceFileTab" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Enter the path to your file</label>
                            <input type="text" id="complianceFilePath" placeholder="/Users/you/Documents/my-document.md">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn" onclick="checkCompliance()">‚úÖ Check Compliance</button>
                    </div>
                </div>

                <div class="card" id="checkComplianceResult" style="display: none;">
                    <h3>Compliance Report</h3>
                    <div id="checkComplianceContent"></div>
                </div>
            </div>

            <!-- Find Duplicates Page -->
            <div class="page" id="find-duplicates">
                <div class="page-header">
                    <h2 class="page-title">üîç Find Citation Duplicates</h2>
                    <p class="page-subtitle">Detect consecutive same citations [^A][^A], orphaned definitions, and missing definitions</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchDuplicatesTab('content')">Paste Content</button>
                    <button class="tab" onclick="switchDuplicatesTab('file')">File Path</button>
                </div>

                <div class="card">
                    <div id="duplicatesContentTab">
                        <div class="form-group">
                            <label class="form-label">Paste your document content</label>
                            <textarea id="findDuplicatesInput" rows="8" placeholder="Paste document content to check for citation integrity issues..."></textarea>
                        </div>
                    </div>
                    <div id="duplicatesFileTab" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Enter the path to your file</label>
                            <input type="text" id="duplicatesFilePath" placeholder="/Users/you/Documents/my-document.md">
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="autoFixDuplicates" style="width: 18px; height: 18px;">
                            <span>Auto-fix consecutive duplicate citations</span>
                        </label>
                    </div>
                    <div class="form-actions">
                        <button class="btn" onclick="findDuplicates()">üîç Find Duplicates</button>
                        <button class="btn btn-secondary" onclick="copyDuplicatesResult()">üìã Copy Result</button>
                    </div>
                </div>

                <div class="card" id="findDuplicatesResult" style="display: none;">
                    <h3>Integrity Report</h3>
                    <div id="findDuplicatesContent"></div>
                </div>
            </div>

            <!-- Verify Context Page -->
            <div class="page" id="verify-context">
                <div class="page-header">
                    <h2 class="page-title">üéØ Verify Citation Context</h2>
                    <p class="page-subtitle">Check if citations match their surrounding text using keyword analysis</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchContextTab('content')">Paste Content</button>
                    <button class="tab" onclick="switchContextTab('file')">File Path</button>
                </div>

                <div class="card">
                    <div id="contextContentTab">
                        <div class="form-group">
                            <label class="form-label">Paste your document content</label>
                            <textarea id="verifyContextInput" rows="8" placeholder="Paste document content to verify citation contexts..."></textarea>
                        </div>
                    </div>
                    <div id="contextFileTab" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Enter the path to your file</label>
                            <input type="text" id="contextFilePath" placeholder="/Users/you/Documents/my-document.md">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Overlap Threshold (0-1)</label>
                            <input type="number" id="contextThreshold" value="0.15" min="0" max="1" step="0.05" style="width: 100px;">
                            <span style="color: var(--text-muted); font-size: 0.9rem; margin-left: 8px;">Lower = more strict</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="deepVerify" style="width: 18px; height: 18px;">
                            <span>Deep verify with LLM (uses local Ollama or Groq, slower but more accurate)</span>
                        </label>
                    </div>
                    <div class="form-actions">
                        <button class="btn" onclick="verifyContext()">üéØ Verify Context</button>
                        <button class="btn btn-secondary" onclick="copyContextResult()">üìã Copy Result</button>
                    </div>
                </div>

                <div class="card" id="verifyContextResult" style="display: none;">
                    <h3>Context Verification Report</h3>
                    <div id="verifyContextContent"></div>
                </div>
            </div>

            <!-- Full Audit Page -->
            <div class="page" id="audit">
                <div class="page-header">
                    <h2 class="page-title">üìä Full Citation Audit</h2>
                    <p class="page-subtitle">Comprehensive audit: duplicates, orphans, missing definitions, and context verification</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchAuditTab('content')">Paste Content</button>
                    <button class="tab" onclick="switchAuditTab('file')">File Path</button>
                </div>

                <div class="card">
                    <div id="auditContentTab">
                        <div class="form-group">
                            <label class="form-label">Paste your document content</label>
                            <textarea id="auditInput" rows="8" placeholder="Paste document content for a comprehensive citation audit..."></textarea>
                        </div>
                    </div>
                    <div id="auditFileTab" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Enter the path to your file</label>
                            <input type="text" id="auditFilePath" placeholder="/Users/you/Documents/my-document.md">
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="auditAutoFix" style="width: 18px; height: 18px;">
                            <span>Auto-fix consecutive duplicate citations</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="auditDeepVerify" style="width: 18px; height: 18px;">
                            <span>Deep verify with LLM (uses local Ollama or Groq, slower but more accurate)</span>
                        </label>
                    </div>
                    <div class="form-actions">
                        <button class="btn" onclick="auditDocument()">üìä Run Full Audit</button>
                        <button class="btn btn-secondary" onclick="copyAuditResult()">üìã Copy Result</button>
                    </div>
                </div>

                <div class="card" id="auditResult" style="display: none;">
                    <div id="auditHealthScore" style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3rem; font-weight: bold;"></div>
                        <div style="color: var(--text-muted);">Health Score</div>
                    </div>
                    <h3>Audit Report</h3>
                    <div id="auditContent"></div>
                </div>
            </div>

            <!-- About Page -->
            <div class="page" id="about">
                <div class="page-header">
                    <h2 class="page-title">About CitationSculptor</h2>
                    <p class="page-subtitle">The comprehensive citation management toolkit for researchers</p>
                </div>

                <div class="card" id="aboutContent">
                    <div class="loading"><div class="spinner"></div>Loading documentation...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Folder Browser Modal -->
    <div id="folderBrowserModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; border-bottom: 1px solid var(--border);">
                <h3 style="margin: 0; color: var(--accent);">üìÇ Select Obsidian Vault</h3>
                <button onclick="closeFolderBrowser()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            </div>
            
            <div id="folderBrowserPath" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin: 16px 0; font-family: monospace; font-size: 0.9rem; word-break: break-all;">
                Loading...
            </div>
            
            <div id="folderBrowserContent" style="flex: 1; overflow-y: auto; min-height: 200px; max-height: 400px;">
                <div class="loading"><div class="spinner"></div>Loading directories...</div>
            </div>
            
            <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 16px; border-top: 1px solid var(--border); margin-top: 16px;">
                <button type="button" class="btn btn-secondary" onclick="closeFolderBrowser()">Cancel</button>
                <button type="button" class="btn btn-primary" id="selectFolderBtn" onclick="selectCurrentFolder()" disabled>
                    ‚úì Select This Folder
                </button>
            </div>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border);
        }
        .folder-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid transparent;
        }
        .folder-item:hover {
            background: var(--bg-secondary);
        }
        .folder-item.vault {
            border-color: var(--accent);
            background: rgba(147, 112, 219, 0.1);
        }
        .folder-item .icon {
            font-size: 1.3rem;
        }
        .folder-item .name {
            flex: 1;
            font-weight: 500;
        }
        .folder-item .badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            background: var(--accent);
            color: white;
        }
        .folder-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .folder-nav:hover {
            background: var(--bg-tertiary);
        }
        .empty-folder {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
    </style>

    <script>
        const API = 'http://127.0.0.1:3019';
        let lastResult = null;
        let lastBatch = null;
        let lastBibliography = null;
        let currentImportType = 'bibtex';

        // Navigation
        document.querySelectorAll('.nav-item[data-page]').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                item.classList.add('active');
                document.getElementById(item.dataset.page).classList.add('active');
            });
        });

        // Enter key handlers
        document.getElementById('lookupInput').addEventListener('keypress', e => { if (e.key === 'Enter') doLookup(); });
        document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') doSearch(); });
        document.getElementById('librarySearch').addEventListener('keypress', e => { if (e.key === 'Enter') searchLibrary(); });

        // PDF Drop Zone
        const pdfDrop = document.getElementById('pdfDrop');
        pdfDrop.addEventListener('dragover', e => { e.preventDefault(); pdfDrop.classList.add('dragover'); });
        pdfDrop.addEventListener('dragleave', () => pdfDrop.classList.remove('dragover'));
        pdfDrop.addEventListener('drop', e => {
            e.preventDefault();
            pdfDrop.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                processPdfFile(e.dataTransfer.files[0]);
            }
        });

        // Check server status
        async function checkServer() {
            const badge = document.getElementById('serverStatus');
            try {
                const res = await fetch(`${API}/health`);
                const data = await res.json();
                if (data.status === 'ok') {
                    badge.textContent = 'Online';
                    badge.className = 'status-badge online';
                }
            } catch (e) {
                badge.textContent = 'Offline';
                badge.className = 'status-badge offline';
            }
        }

        // === Recent Lookups (localStorage) ===
        const RECENT_KEY = 'citationSculptor_recentLookups';
        const MAX_RECENT = 50;

        function getRecentLookups() {
            try {
                return JSON.parse(localStorage.getItem(RECENT_KEY) || '[]');
            } catch {
                return [];
            }
        }

        function addRecentLookup(identifier, data) {
            const recent = getRecentLookups();
            // Remove if already exists (will re-add at top)
            const filtered = recent.filter(r => r.identifier !== identifier);
            // Add to front
            filtered.unshift({
                identifier,
                inline_mark: data.inline_mark,
                full_citation: data.full_citation,
                title: data.metadata?.title || data.full_citation?.substring(0, 80) || identifier,
                identifier_type: data.identifier_type || 'unknown',
                timestamp: Date.now()
            });
            // Keep only MAX_RECENT
            const trimmed = filtered.slice(0, MAX_RECENT);
            localStorage.setItem(RECENT_KEY, JSON.stringify(trimmed));
            renderRecentLookups();
        }

        function clearRecentLookups() {
            if (confirm('Clear all recent lookups?')) {
                localStorage.removeItem(RECENT_KEY);
                renderRecentLookups();
                showToast('Recent lookups cleared');
            }
        }

        function renderRecentLookups() {
            const recent = getRecentLookups();
            const container = document.getElementById('recentList');
            const countEl = document.getElementById('recentCount');
            
            if (!container) return;
            
            countEl.textContent = `${recent.length} recent lookup${recent.length !== 1 ? 's' : ''}`;
            
            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="message info">
                        <span>üí°</span>
                        <span>No recent lookups yet. Use Quick Lookup or Search to find citations.</span>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recent.map((r, i) => `
                <div class="card" style="padding: 12px; background: var(--bg-secondary);">
                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; margin-bottom: 4px; color: var(--text-primary);">
                                ${escHtml(r.title?.substring(0, 80) || r.identifier)}${(r.title?.length || 0) > 80 ? '...' : ''}
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                                <code style="background: var(--bg-base); padding: 2px 6px; border-radius: 4px;">${escHtml(r.identifier_type)}</code>
                                <span style="margin-left: 8px;">${new Date(r.timestamp).toLocaleDateString()}</span>
                            </div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--accent);">
                                ${escHtml(r.inline_mark)}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-shrink: 0;">
                            <button class="btn btn-sm btn-secondary" onclick="copyText('${esc(r.inline_mark)}')">Copy</button>
                            <button class="btn btn-sm btn-primary" onclick="lookupAgain('${esc(r.identifier)}')">Look Up</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function lookupAgain(identifier) {
            document.getElementById('lookupInput').value = identifier;
            document.querySelector('[data-page="lookup"]').click();
            setTimeout(() => doLookup(), 100);
        }

        // Initialize recent lookups on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderRecentLookups();
        });

        // === Corrections Workflow ===
        let currentCorrections = [];
        let originalContent = '';

        async function generateCorrections() {
            const content = document.getElementById('correctionsInput').value.trim();
            if (!content) {
                showToast('Please paste document content', 'error');
                return;
            }
            
            originalContent = content;
            const container = document.getElementById('correctionsResult');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Finding citations needing corrections...</div>';
            
            try {
                const res = await fetch(`${API}/api/corrections/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                const data = await res.json();
                
                if (data.success) {
                    if (!data.has_corrections) {
                        container.innerHTML = `
                            <div class="message success">
                                <span>‚úÖ</span>
                                <span>All citations are complete! No corrections needed.</span>
                            </div>
                        `;
                        document.getElementById('correctionsEditCard').style.display = 'none';
                    } else {
                        currentCorrections = data.citations;
                        container.innerHTML = `
                            <div class="message warning">
                                <span>‚ö†Ô∏è</span>
                                <span><strong>${data.count}</strong> citation(s) need corrections. Edit them below.</span>
                            </div>
                        `;
                        renderCorrectionsEditor();
                    }
                } else {
                    container.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error)}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        function renderCorrectionsEditor() {
            const card = document.getElementById('correctionsEditCard');
            const list = document.getElementById('correctionsEditList');
            card.style.display = 'block';
            
            list.innerHTML = currentCorrections.map((cit, i) => `
                <div class="card" style="padding: 16px; background: var(--bg-secondary); margin-bottom: 12px;">
                    <div style="font-weight: 600; color: var(--accent); margin-bottom: 8px;">
                        ${i + 1}. ${escHtml(cit.tag)}
                    </div>
                    ${cit.url ? `<div style="font-size: 12px; margin-bottom: 8px;"><a href="${escHtml(cit.url)}" target="_blank" style="color: var(--text-muted);">${escHtml(cit.url.substring(0, 60))}${cit.url.length > 60 ? '...' : ''}</a></div>` : ''}
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px; padding: 8px; background: var(--bg-base); border-radius: 4px;">
                        ${escHtml(cit.citation.substring(0, 150))}${cit.citation.length > 150 ? '...' : ''}
                    </div>
                    <div style="font-size: 12px; margin-bottom: 12px;">
                        <strong>Missing:</strong> <span style="color: var(--warning);">${cit.missing.join(', ')}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        ${cit.missing.includes('Date') ? `
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px;">Date</label>
                                <input type="text" id="corr_${i}_date" placeholder="YYYY or YYYY-MM-DD" style="font-size: 13px;">
                            </div>
                        ` : ''}
                        ${cit.missing.includes('Authors') ? `
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px;">Authors</label>
                                <input type="text" id="corr_${i}_authors" placeholder="Smith J, Jones A" style="font-size: 13px;">
                            </div>
                        ` : ''}
                        ${cit.missing.includes('Organization') ? `
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px;">Organization</label>
                                <input type="text" id="corr_${i}_organization" placeholder="Organization name" style="font-size: 13px;">
                            </div>
                        ` : ''}
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 12px;">New Tag (optional)</label>
                            <input type="text" id="corr_${i}_newtag" placeholder="[^AuthorAB-2024]" style="font-size: 13px;">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function applyCorrections() {
            if (!currentCorrections.length || !originalContent) {
                showToast('No corrections to apply', 'error');
                return;
            }
            
            // Gather corrections from the form
            const corrections = currentCorrections.map((cit, i) => {
                const corr = { tag: cit.tag };
                const dateEl = document.getElementById(`corr_${i}_date`);
                const authorsEl = document.getElementById(`corr_${i}_authors`);
                const orgEl = document.getElementById(`corr_${i}_organization`);
                const newtagEl = document.getElementById(`corr_${i}_newtag`);
                
                if (dateEl?.value) corr.date = dateEl.value.trim();
                if (authorsEl?.value) corr.authors = authorsEl.value.trim();
                if (orgEl?.value) corr.organization = orgEl.value.trim();
                if (newtagEl?.value) corr.new_tag = newtagEl.value.trim();
                
                return corr;
            });
            
            try {
                const res = await fetch(`${API}/api/corrections/apply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: originalContent, corrections })
                });
                const data = await res.json();
                
                if (data.success) {
                    // Update the input with corrected content
                    document.getElementById('correctionsInput').value = data.corrected_content;
                    originalContent = data.corrected_content;
                    
                    showToast(`Applied ${data.applied_count} correction(s)!`);
                    
                    // Re-check for remaining corrections
                    await generateCorrections();
                } else {
                    showToast(data.error || 'Failed to apply corrections', 'error');
                }
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        function downloadCorrections() {
            if (!currentCorrections.length) {
                showToast('No corrections to download', 'error');
                return;
            }
            
            // Build template
            const lines = [
                '# Citation Corrections Template',
                '',
                `## ${currentCorrections.length} Citation(s) Need Corrections`,
                '',
            ];
            
            currentCorrections.forEach((cit, i) => {
                lines.push(`### ${i + 1}. ${cit.tag}`);
                lines.push('');
                if (cit.url) lines.push(`**URL**: ${cit.url}`);
                lines.push('');
                lines.push(`**Current**: ${cit.citation.substring(0, 150)}...`);
                lines.push('');
                lines.push(`**Missing**: ${cit.missing.join(', ')}`);
                lines.push('');
                cit.missing.forEach(m => lines.push(`- ${m}: `));
                lines.push('- New Tag: ');
                lines.push('');
                lines.push('---');
                lines.push('');
            });
            
            const blob = new Blob([lines.join('\\n')], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'corrections_template.md';
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Template downloaded!');
        }

        // Lookup
        async function doLookup() {
            const input = document.getElementById('lookupInput').value.trim();
            if (!input) return;

            const style = document.getElementById('styleSelect').value;
            const container = document.getElementById('lookupResult');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Looking up...</div>';

            try {
                const res = await fetch(`${API}/api/lookup?id=${encodeURIComponent(input)}&style=${style}`);
                const data = await res.json();
                lastResult = data;

                if (data.success) {
                    // Save to recent lookups
                    addRecentLookup(input, data);
                    
                    container.innerHTML = `
                        <div class="result-box">
                            <div class="result-header">
                                <span class="result-label">Inline Reference</span>
                                <button class="btn btn-sm btn-secondary" onclick="copyText('${esc(data.inline_mark)}')">Copy</button>
                            </div>
                            <div class="result-content">
                                <div class="result-text inline">${escHtml(data.inline_mark)}</div>
                            </div>
                        </div>
                        <div class="result-box">
                            <div class="result-header">
                                <span class="result-label">Full Citation</span>
                                <button class="btn btn-sm btn-secondary" onclick="copyText(\`${esc(data.full_citation)}\`)">Copy</button>
                            </div>
                            <div class="result-content">
                                <div class="result-text">${escHtml(data.full_citation)}</div>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error || 'Not found')}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        // Save citation to library
        async function saveCitation() {
            if (!lastResult || !lastResult.success) {
                showToast('No citation to save', 'error');
                return;
            }

            try {
                const res = await fetch(`${API}/api/library/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        citation: {
                            identifier_type: lastResult.identifier_type,
                            identifier: lastResult.identifier,
                            title: lastResult.metadata?.title || '',
                            authors: lastResult.metadata?.authors || [],
                            year: lastResult.metadata?.year || '',
                            style: document.getElementById('styleSelect').value,
                            inline_mark: lastResult.inline_mark,
                            full_citation: lastResult.full_citation,
                            metadata: lastResult.metadata,
                            tags: [],
                        }
                    })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Citation saved to library!');
                } else {
                    showToast(data.error || 'Save failed', 'error');
                }
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        // Search
        async function doSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            const source = document.getElementById('searchSource').value;
            const max = document.getElementById('searchMax').value;
            const container = document.getElementById('searchResults');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Searching...</div>';

            try {
                const res = await fetch(`${API}/api/search?q=${encodeURIComponent(query)}&source=${source}&max=${max}`);
                const data = await res.json();

                if (data.results && data.results.length > 0) {
                    container.innerHTML = `
                        <div style="margin-top: 16px; color: var(--text-secondary); font-size: 13px;">
                            Found ${data.count} result(s) from ${source}
                        </div>
                        <div class="search-results">
                            ${data.results.map((r, i) => `
                                <div class="search-item">
                                    <div class="search-item-title">${i + 1}. ${escHtml(r.title || 'Untitled')}</div>
                                    <div class="search-item-meta">
                                        ${escHtml((r.authors || []).slice(0, 2).join(', '))}${r.authors?.length > 2 ? ' et al.' : ''} ¬∑ ${escHtml(r.journal || '')} (${r.year || 'n.d.'})
                                    </div>
                                    <div class="search-item-ids">
                                        ${r.pmid ? `<span class="id-badge">PMID: ${r.pmid}</span>` : ''}
                                        ${r.doi ? `<span class="id-badge">DOI: ${escHtml(r.doi)}</span>` : ''}
                                        ${r.citation_count ? `<span class="id-badge">Cited: ${r.citation_count}</span>` : ''}
                                    </div>
                                    <div class="btn-group">
                                        <button class="btn btn-sm" onclick="getCitation('${r.pmid || r.doi || ''}')">Get Citation</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><p>No results found</p></div>';
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        async function getCitation(id) {
            document.getElementById('lookupInput').value = id;
            document.querySelector('[data-page="lookup"]').click();
            await doLookup();
        }

        // Batch
        async function doBatch() {
            const input = document.getElementById('batchInput').value.trim();
            if (!input) return;

            const identifiers = input.split('\n').map(s => s.trim()).filter(s => s && !s.startsWith('#'));
            const style = document.getElementById('batchStyle').value;
            const container = document.getElementById('batchResults');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Processing...</div>';

            try {
                const res = await fetch(`${API}/api/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifiers, style })
                });
                const data = await res.json();
                lastBatch = data.results;

                const successful = data.results.filter(r => r.success);
                const failed = data.results.filter(r => !r.success);

                container.innerHTML = `
                    <div style="margin-top: 16px; color: var(--text-secondary);">
                        <span style="color: var(--success);">‚úì ${successful.length} successful</span>
                        ${failed.length > 0 ? `<span style="color: var(--error); margin-left: 16px;">‚úó ${failed.length} failed</span>` : ''}
                    </div>
                    ${successful.length > 0 ? `
                        <div class="result-box" style="margin-top: 16px;">
                            <div class="result-header">
                                <span class="result-label">Citations</span>
                            </div>
                            <div class="result-content">
                                <textarea readonly style="width: 100%; min-height: 200px; background: var(--bg-base); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 12px;">${successful.map(r => r.full_citation).join('\n\n')}</textarea>
                            </div>
                        </div>
                    ` : ''}
                    ${failed.length > 0 ? `
                        <div class="message error" style="margin-top: 16px;">
                            Failed: ${failed.map(r => escHtml(r.identifier)).join(', ')}
                        </div>
                    ` : ''}
                `;
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        function copyBatchResult() {
            if (!lastBatch) return;
            const text = lastBatch.filter(r => r.success).map(r => r.full_citation).join('\n\n');
            copyText(text);
        }

        // PDF Upload
        function handlePdfUpload(event) {
            const file = event.target.files[0];
            if (file) processPdfFile(file);
        }

        async function processPdfFile(file) {
            const container = document.getElementById('pdfResult');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Extracting metadata...</div>';

            try {
                const base64 = await fileToBase64(file);
                const res = await fetch(`${API}/api/pdf/extract`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pdf_base64: base64 })
                });
                const data = await res.json();

                if (data.success) {
                    const m = data.metadata;
                    container.innerHTML = `
                        <div class="result-box">
                            <div class="result-header">
                                <span class="result-label">Extracted Metadata</span>
                            </div>
                            <div class="result-content">
                                <p><strong>Title:</strong> ${escHtml(m.title || 'Not found')}</p>
                                <p><strong>Authors:</strong> ${escHtml((m.authors || []).join(', ') || 'Not found')}</p>
                                <p><strong>DOI:</strong> ${escHtml(m.doi || 'Not found')}</p>
                                <p><strong>PMID:</strong> ${escHtml(m.pmid || 'Not found')}</p>
                                <p><strong>arXiv ID:</strong> ${escHtml(m.arxiv_id || 'Not found')}</p>
                                <p><strong>Pages:</strong> ${m.page_count || 'Unknown'}</p>
                            </div>
                        </div>
                        ${data.citation ? `
                            <div class="result-box">
                                <div class="result-header">
                                    <span class="result-label">Generated Citation</span>
                                    <button class="btn btn-sm btn-secondary" onclick="copyText(\`${esc(data.citation.full_citation)}\`)">Copy</button>
                                </div>
                                <div class="result-content">
                                    <div class="result-text">${escHtml(data.citation.full_citation)}</div>
                                </div>
                            </div>
                        ` : `
                            <div class="message info">No identifier found. Try searching by title.</div>
                        `}
                    `;
                } else {
                    container.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error)}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Library
        async function loadLibrary() {
            const container = document.getElementById('libraryResults');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            try {
                const [libRes, tagsRes] = await Promise.all([
                    fetch(`${API}/api/library`),
                    fetch(`${API}/api/library/tags`)
                ]);
                const libData = await libRes.json();
                const tagsData = await tagsRes.json();

                document.getElementById('statTotal').textContent = libData.total || 0;
                document.getElementById('statTags').textContent = (tagsData.tags || []).length;

                if (libData.citations && libData.citations.length > 0) {
                    container.innerHTML = `
                        <div class="library-grid">
                            ${libData.citations.map(c => `
                                <div class="citation-card">
                                    <div class="citation-title">${escHtml(c.title || 'Untitled')}</div>
                                    <div class="citation-meta">${escHtml((c.authors || []).slice(0, 2).join(', '))}${c.authors?.length > 2 ? ' et al.' : ''} (${c.year || 'n.d.'})</div>
                                    ${c.tags && c.tags.length ? `
                                        <div class="citation-tags">
                                            ${c.tags.map(t => `<span class="tag">${escHtml(t)}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-secondary" onclick="copyText(\`${esc(c.full_citation)}\`)">Copy</button>
                                        <button class="btn btn-sm btn-secondary" onclick="deleteCitation(${c.id})">Delete</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üóÉÔ∏è</div><p>Your library is empty</p></div>';
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        async function searchLibrary() {
            const query = document.getElementById('librarySearch').value.trim();
            if (!query) { loadLibrary(); return; }

            const container = document.getElementById('libraryResults');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Searching...</div>';

            try {
                const res = await fetch(`${API}/api/library/search?q=${encodeURIComponent(query)}`);
                const data = await res.json();

                if (data.citations && data.citations.length > 0) {
                    container.innerHTML = `
                        <div class="library-grid">
                            ${data.citations.map(c => `
                                <div class="citation-card">
                                    <div class="citation-title">${escHtml(c.title || 'Untitled')}</div>
                                    <div class="citation-meta">${escHtml((c.authors || []).join(', '))} (${c.year})</div>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-secondary" onclick="copyText(\`${esc(c.full_citation)}\`)">Copy</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><p>No citations match your search</p></div>';
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        async function deleteCitation(id) {
            if (!confirm('Delete this citation?')) return;
            try {
                await fetch(`${API}/api/library/delete?id=${id}`, { method: 'DELETE' });
                showToast('Citation deleted');
                loadLibrary();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        // Bibliography
        async function generateBibliography() {
            const input = document.getElementById('bibInput').value.trim();
            if (!input) return;

            const identifiers = input.split('\n').map(s => s.trim()).filter(s => s && !s.startsWith('#'));
            const style = document.getElementById('bibStyle').value;
            const sort = document.getElementById('bibSort').value;
            const container = document.getElementById('bibResult');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Generating bibliography...</div>';

            try {
                const res = await fetch(`${API}/api/bibliography/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifiers, style, sort })
                });
                const data = await res.json();
                lastBibliography = data.bibliography;

                container.innerHTML = `
                    <div style="margin-top: 16px; color: var(--text-secondary); font-size: 13px;">
                        Generated ${data.entries} citations ${data.failed > 0 ? `(${data.failed} failed)` : ''}
                    </div>
                    <div class="result-box" style="margin-top: 16px;">
                        <div class="result-header">
                            <span class="result-label">Bibliography</span>
                        </div>
                        <div class="result-content">
                            <textarea readonly style="width: 100%; min-height: 300px; background: var(--bg-base); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 12px;">${escHtml(data.bibliography)}</textarea>
                        </div>
                    </div>
                `;
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        function copyBibliography() {
            if (lastBibliography) copyText(lastBibliography);
        }

        // Import
        function switchImportTab(type) {
            currentImportType = type;
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tabs .tab:${type === 'bibtex' ? 'first-child' : 'last-child'}`).classList.add('active');
            document.getElementById('importLabel').textContent = `Paste ${type === 'bibtex' ? 'BibTeX' : 'RIS'} content`;
            document.getElementById('importInput').placeholder = type === 'bibtex' ? '@article{...}' : 'TY  - JOUR\n...';
        }

        async function doImport() {
            const input = document.getElementById('importInput').value.trim();
            if (!input) return;

            const container = document.getElementById('importResult');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Importing...</div>';

            try {
                const res = await fetch(`${API}/api/import/${currentImportType}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [currentImportType]: input })
                });
                const data = await res.json();

                if (data.imported > 0) {
                    container.innerHTML = `
                        <div class="message success">‚úì Imported ${data.imported} citation(s)</div>
                        <div class="search-results">
                            ${data.results.map(r => `
                                <div class="search-item">
                                    <div class="search-item-title">${escHtml(r.inline_mark || r.identifier)}</div>
                                    <div class="result-text" style="font-size: 12px; margin-top: 8px;">${escHtml(r.full_citation || '')}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error || 'No valid entries found')}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        // Export
        async function doExport() {
            const ids = document.getElementById('exportIds').value.trim();
            const format = document.getElementById('exportFormat').value;

            if (!ids) {
                showToast('Please enter citation IDs to export', 'error');
                return;
            }

            window.open(`${API}/api/export/${format}?ids=${encodeURIComponent(ids)}`, '_blank');
        }

        // Document Processing
        let currentDocTab = 'content';
        let lastProcessedDoc = null;

        async function processDocumentWithProgress(requestBody, container) {
            return new Promise((resolve) => {
                try {
                    // Create a fetch request that we'll read as a stream
                    fetch(`${API}/api/process-document-stream`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    }).then(response => {
                        if (!response.ok) {
                            resolve(false); // Fallback to regular endpoint
                            return;
                        }
                        
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';
                        
                        function processSSE(text) {
                            const lines = text.split('\n');
                            let eventType = null;
                            let eventData = null;
                            
                            for (const line of lines) {
                                if (line.startsWith('event: ')) {
                                    eventType = line.slice(7).trim();
                                } else if (line.startsWith('data: ')) {
                                    eventData = line.slice(6);
                                    if (eventType && eventData) {
                                        try {
                                            const data = JSON.parse(eventData);
                                            handleSSEEvent(eventType, data, container, resolve);
                                        } catch (e) {
                                            console.warn('Failed to parse SSE data:', e);
                                        }
                                        eventType = null;
                                        eventData = null;
                                    }
                                }
                            }
                        }
                        
                        function read() {
                            reader.read().then(({ done, value }) => {
                                if (done) {
                                    if (buffer) processSSE(buffer);
                                    return;
                                }
                                
                                buffer += decoder.decode(value, { stream: true });
                                
                                // Process complete events from buffer
                                const events = buffer.split('\n\n');
                                buffer = events.pop() || ''; // Keep incomplete event in buffer
                                
                                for (const event of events) {
                                    if (event.trim()) {
                                        processSSE(event + '\n');
                                    }
                                }
                                
                                read();
                            }).catch(err => {
                                console.error('Stream read error:', err);
                                resolve(false);
                            });
                        }
                        
                        read();
                    }).catch(err => {
                        console.error('Fetch error:', err);
                        resolve(false);
                    });
                } catch (e) {
                    console.error('Stream setup error:', e);
                    resolve(false);
                }
            });
        }
        
        function handleSSEEvent(eventType, data, container, resolve) {
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const progressPhase = document.getElementById('progressPhase');
            const progressMessage = document.getElementById('progressMessage');
            const liveTotal = document.getElementById('liveTotal');
            const liveProcessed = document.getElementById('liveProcessed');
            const liveFailed = document.getElementById('liveFailed');
            const currentRef = document.getElementById('currentRef');
            const currentRefTitle = document.getElementById('currentRefTitle');
            
            switch (eventType) {
                case 'status':
                    if (progressPhase) {
                        const icons = {
                            'analyzing': 'üîç',
                            'parsing': 'üìù',
                            'finalizing': '‚ú®',
                            'saving': 'üíæ'
                        };
                        progressPhase.textContent = `${icons[data.phase] || 'üîÑ'} ${data.message}`;
                    }
                    if (progressMessage) progressMessage.textContent = data.message;
                    break;
                    
                case 'analysis':
                    if (progressMessage) progressMessage.textContent = 'Document analyzed - found existing citations and references';
                    break;
                    
                case 'refs_found':
                    if (liveTotal) liveTotal.textContent = data.total;
                    if (progressMessage) progressMessage.textContent = data.message;
                    if (data.total === 0) {
                        if (progressPhase) progressPhase.textContent = '‚úÖ Analysis complete';
                    }
                    break;
                    
                case 'progress':
                    if (progressBar) progressBar.style.width = `${data.percent}%`;
                    if (progressPercent) progressPercent.textContent = `${data.percent}%`;
                    if (progressPhase) progressPhase.textContent = `‚öôÔ∏è Processing reference ${data.current} of ${data.total}`;
                    if (progressMessage) progressMessage.textContent = `Looking up: ${data.processing}`;
                    if (liveProcessed) liveProcessed.textContent = data.stats.processed;
                    if (liveFailed) {
                        liveFailed.textContent = data.stats.failed;
                        liveFailed.style.color = data.stats.failed > 0 ? 'var(--error)' : 'var(--text-muted)';
                    }
                    if (currentRef) {
                        currentRef.style.display = 'block';
                        currentRefTitle.textContent = data.processing;
                    }
                    break;
                    
                case 'ref_processed':
                    // Update live counters immediately
                    const processed = parseInt(liveProcessed?.textContent || '0');
                    const failed = parseInt(liveFailed?.textContent || '0');
                    if (data.success) {
                        if (liveProcessed) liveProcessed.textContent = processed + 1;
                    } else {
                        if (liveFailed) {
                            liveFailed.textContent = failed + 1;
                            liveFailed.style.color = 'var(--error)';
                        }
                    }
                    break;
                    
                case 'error':
                    container.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error)}</div>`;
                    if (data.backup_path) {
                        container.innerHTML += `<div class="message info" style="margin-top: 8px;">üì¶ Backup available at: <code>${escHtml(data.backup_path)}</code></div>`;
                    }
                    resolve(true); // Handled (with error)
                    break;
                    
                case 'complete':
                    // Render final results
                    lastProcessedDoc = data.processed_content;
                    renderDocumentResults(data, container);
                    resolve(true); // Successfully handled
                    break;
            }
        }
        
        function renderDocumentResults(data, container) {
            const stats = data.statistics || {};
            const docStats = stats.document_analysis || {};
            
            container.innerHTML = `
                <h4 style="margin: 20px 0 12px 0; color: var(--accent);">üìä Document Analysis</h4>
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-value">${docStats.total_inline_references ?? 0}</div>
                        <div class="stat-label">Inline References</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${docStats.total_citations ?? 0}</div>
                        <div class="stat-label">Citations in Doc</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${docStats.total_identifiers ?? 0}</div>
                        <div class="stat-label">Identifiers Found</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${docStats.markdown_links ?? 0}</div>
                        <div class="stat-label">Markdown Links</div>
                    </div>
                </div>
                
                <details style="margin-bottom: 16px;">
                    <summary style="cursor: pointer; color: var(--accent); font-weight: 500;">üìã Detailed Breakdown</summary>
                    <div style="margin-top: 12px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; font-size: 0.9rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            <div><strong>Inline References:</strong>
                                <ul style="margin: 4px 0 0 20px; padding: 0;">
                                    <li>Numeric [1]: ${docStats.inline_numeric ?? 0}</li>
                                    <li>Footnote [^ref]: ${docStats.inline_footnote ?? 0}</li>
                                    <li>Author-year: ${docStats.inline_author_year ?? 0}</li>
                                </ul>
                            </div>
                            <div><strong>Reference Section:</strong>
                                <ul style="margin: 4px 0 0 20px; padding: 0;">
                                    <li>Items: ${docStats.reference_section_items ?? 0}</li>
                                    <li>Footnote defs: ${docStats.footnote_definitions ?? 0}</li>
                                </ul>
                            </div>
                            <div><strong>Identifiers:</strong>
                                <ul style="margin: 4px 0 0 20px; padding: 0;">
                                    <li>PubMed URLs: ${docStats.pubmed_urls ?? 0}</li>
                                    <li>DOI links: ${docStats.doi_links ?? 0}</li>
                                    <li>PMID mentions: ${docStats.pmid_mentions ?? 0}</li>
                                    <li>PMC IDs: ${docStats.pmcid_mentions ?? 0}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </details>
                
                <h4 style="margin: 20px 0 12px 0; color: var(--accent);">‚öôÔ∏è Processing Results</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_references ?? 0}</div>
                        <div class="stat-label">Total References</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--success);">${stats.processed ?? 0}</div>
                        <div class="stat-label">‚úÖ Processed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: ${(stats.needs_review || 0) > 0 ? 'var(--warning)' : 'var(--text-muted)'};">${stats.needs_review ?? 0}</div>
                        <div class="stat-label">‚ö†Ô∏è Needs Review</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: ${(stats.failed || 0) > 0 ? 'var(--error)' : 'var(--text-muted)'};">${stats.failed ?? 0}</div>
                        <div class="stat-label">‚ùå Failed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: ${(stats.orphaned || 0) > 0 ? 'var(--text-muted)' : 'var(--text-muted)'};">${stats.orphaned ?? 0}</div>
                        <div class="stat-label">üóëÔ∏è Orphaned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: ${(stats.duplicates_merged || 0) > 0 ? 'var(--accent)' : 'var(--text-muted)'};">${stats.duplicates_merged ?? 0}</div>
                        <div class="stat-label">üîó Duplicates Merged</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.inline_replacements ?? 0}</div>
                        <div class="stat-label">üîÑ Replacements</div>
                    </div>
                </div>
                ${data.dry_run ? `
                    <div class="message info" style="margin: 12px 0; padding: 16px; background: rgba(99, 102, 241, 0.1); border-left: 4px solid var(--accent);">
                        <span>üëÅÔ∏è</span>
                        <span><strong>DRY RUN MODE</strong> ‚Äî This is a preview only. No changes have been saved. Uncheck "Dry Run" to process and save.</span>
                    </div>
                ` : ''}
                ${data.multi_section ? `
                    <div class="message info" style="margin: 12px 0; padding: 12px; font-size: 0.9rem;">
                        <span>üìë</span>
                        <span>Multi-section mode: Reference sections were processed independently.</span>
                    </div>
                ` : ''}
                ${(stats.orphaned || 0) > 0 ? `
                    <div class="message info" style="margin: 12px 0; padding: 12px; font-size: 0.9rem;">
                        <span>üóëÔ∏è</span>
                        <span><strong>${stats.orphaned}</strong> orphaned reference(s) were found in the reference section but not cited in the document body. They have been moved to the "Unused References" section.</span>
                    </div>
                ` : ''}
                ${(stats.duplicates_merged || 0) > 0 ? `
                    <div class="message info" style="margin: 12px 0; padding: 12px; font-size: 0.9rem;">
                        <span>üîó</span>
                        <span><strong>${stats.duplicates_merged}</strong> duplicate reference(s) were detected and merged into single citations.</span>
                    </div>
                ` : ''}
                ${(stats.needs_review || 0) > 0 ? `
                    <div class="message warning" style="margin: 12px 0; padding: 12px; font-size: 0.9rem;">
                        <span>‚ö†Ô∏è</span>
                        <span><strong>${stats.needs_review}</strong> citation(s) may need manual review. Check the "Citations Requiring Review" section in the processed document.</span>
                    </div>
                ` : ''}
                ${data.saved_to_file ? `
                    <div class="message success" style="margin: 16px 0; padding: 16px;">
                        <span>üíæ</span>
                        <div style="flex: 1;">
                            <strong>File saved successfully!</strong><br>
                            <span style="font-size: 0.9rem;">üìÑ Saved to: <code>${escHtml(data.saved_path || '')}</code></span><br>
                            ${data.backup_path ? `<span style="font-size: 0.9rem;">üì¶ Backup at: <code>${escHtml(data.backup_path)}</code></span>` : ''}
                        </div>
                    </div>
                    ${data.backup_path ? `
                    <div style="margin: 8px 0 16px 0; padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--warning);">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                            <div>
                                <div style="font-weight: 600; color: var(--warning); margin-bottom: 4px;">‚ö†Ô∏è Need to undo these changes?</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">Click the button to restore the original file from backup.</div>
                            </div>
                            <button onclick="restoreFromBackup('${escHtml(data.backup_path)}', '${escHtml(data.saved_path || '')}')" 
                                    style="background: var(--warning); color: #000; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; white-space: nowrap;">
                                üîÑ Restore Original
                            </button>
                        </div>
                        
                        <details style="margin-top: 12px;">
                            <summary style="cursor: pointer; font-size: 0.85rem; color: var(--text-muted);">
                                Show manual restore options
                            </summary>
                            <div style="margin-top: 12px; font-size: 0.9rem;">
                                <div style="margin-bottom: 12px;">
                                    <strong>Option 1: In Finder</strong>
                                    <ol style="margin: 4px 0 0 20px; padding: 0;">
                                        <li>Navigate to the backup file location</li>
                                        <li>Delete or rename the current file</li>
                                        <li>Rename the backup file (remove the _backup_YYYYMMDD_HHMMSS part)</li>
                                    </ol>
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <strong>Option 2: Terminal command</strong>
                                    <div style="background: var(--bg-base); padding: 8px 12px; border-radius: 4px; margin-top: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; position: relative;">
                                        <code>cp "${escHtml(data.backup_path)}" "${escHtml(data.saved_path || '')}"</code>
                                        <button onclick="navigator.clipboard.writeText('cp \\'${escHtml(data.backup_path)}\\' \\'${escHtml(data.saved_path || '')}\\''); showToast('Restore command copied!', 'success');" 
                                                style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: var(--accent); border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; color: white;">
                                            üìã Copy
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </details>
                    </div>
                    ` : ''}
                ` : data.backup_path && !data.saved_to_file ? `
                    <div class="message info" style="margin: 16px 0;">
                        <span>üì¶</span>
                        <span>Backup created: <code style="font-size: 0.85rem;">${escHtml(data.backup_path)}</code></span>
                    </div>
                ` : ''}
                ${data.save_error ? `
                    <div class="message error" style="margin: 16px 0;">
                        <span>‚ö†Ô∏è</span>
                        <span>Failed to save file: ${escHtml(data.save_error)}. Use "Download" to save manually.</span>
                    </div>
                ` : ''}
                ${(stats.total_references ?? 0) === 0 && (docStats.total_citations ?? 0) > 0 ? `
                    <div class="message success" style="margin: 16px 0;">
                        <span>‚úÖ</span>
                        <span>This document already has ${docStats.total_citations} formatted citations with ${docStats.total_inline_references} inline references. No processing needed!</span>
                    </div>
                ` : (stats.total_references ?? 0) === 0 ? `
                    <div class="message info" style="margin: 16px 0;">
                        <span>üí°</span>
                        <span>No processable references found. Add PubMed URLs or citation markers to process.</span>
                    </div>
                ` : ''}
                ${data.failed_references && data.failed_references.length > 0 ? `
                    <details style="margin-bottom: 16px;" open>
                        <summary style="cursor: pointer; padding: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 8px; color: var(--error);">
                            <strong>‚ö†Ô∏è ${data.failed_references.length} reference(s) could not be resolved</strong>
                        </summary>
                        <div style="margin-top: 8px; border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 8px; overflow: hidden;">
                            ${data.failed_references.map((r, i) => `
                                <div style="padding: 12px; ${i > 0 ? 'border-top: 1px solid var(--border);' : ''} background: var(--bg-secondary);">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <strong style="color: var(--error);">Reference #${r.original_number}</strong>
                                        <span style="font-size: 0.75rem; padding: 2px 8px; background: rgba(239, 68, 68, 0.15); border-radius: 4px; color: var(--error);">${escHtml(r.error_type || 'unknown')}</span>
                                    </div>
                                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 6px;">
                                        ${r.title ? `<strong>Title:</strong> ${escHtml(r.title.substring(0, 80))}${r.title.length > 80 ? '...' : ''}<br>` : ''}
                                        ${r.url ? `<strong>URL:</strong> <code style="font-size: 0.8rem;">${escHtml(r.url.substring(0, 60))}${r.url.length > 60 ? '...' : ''}</code><br>` : ''}
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--error); margin-bottom: 4px;">
                                        <strong>Error:</strong> ${escHtml(r.error || 'Unknown error')}
                                    </div>
                                    ${r.suggestion ? `
                                        <div style="font-size: 0.85rem; color: var(--accent); background: var(--accent-muted); padding: 8px; border-radius: 4px; margin-top: 8px;">
                                            üí° <strong>Suggestion:</strong> ${escHtml(r.suggestion)}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </details>
                ` : ''}
                <div class="result-box">
                    <div class="result-header">
                        <span class="result-label">Processed Document</span>
                    </div>
                    <div class="result-content">
                        <textarea readonly style="width: 100%; min-height: 400px; background: var(--bg-base); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 12px;">${escHtml(data.processed_content)}</textarea>
                    </div>
                </div>
            `;
            
            // Store backup path for restore functionality
            if (data.backup_path && data.saved_to_file) {
                window.lastBackupPath = data.backup_path;
                window.lastSavedPath = data.saved_path;
            }
        }
        
        function switchDocTab(tab) {
            currentDocTab = tab;
            document.querySelectorAll('#document .tabs .tab').forEach((t, i) => {
                t.classList.toggle('active', (tab === 'content' && i === 0) || (tab === 'file' && i === 1));
            });
            document.getElementById('docContentTab').style.display = tab === 'content' ? 'block' : 'none';
            document.getElementById('docFileTab').style.display = tab === 'file' ? 'block' : 'none';
            
            // Show save option only when using file path
            document.getElementById('saveOptionsRow').style.display = tab === 'file' ? 'block' : 'none';
        }

        // Tab switching functions for Document Intelligence pages
        let currentVerifyLinksTab = 'content';
        function switchVerifyLinksTab(tab) {
            currentVerifyLinksTab = tab;
            document.querySelectorAll('#verify-links .tabs .tab').forEach((t, i) => {
                t.classList.toggle('active', 
                    (tab === 'content' && i === 0) || 
                    (tab === 'file' && i === 1) || 
                    (tab === 'urls' && i === 2));
            });
            document.getElementById('verifyLinksContentTab').style.display = tab === 'content' ? 'block' : 'none';
            document.getElementById('verifyLinksFileTab').style.display = tab === 'file' ? 'block' : 'none';
            document.getElementById('verifyLinksUrlsTab').style.display = tab === 'urls' ? 'block' : 'none';
        }

        let currentSuggestTab = 'content';
        function switchSuggestTab(tab) {
            currentSuggestTab = tab;
            document.querySelectorAll('#suggest-citations .tabs .tab').forEach((t, i) => {
                t.classList.toggle('active', (tab === 'content' && i === 0) || (tab === 'file' && i === 1));
            });
            document.getElementById('suggestContentTab').style.display = tab === 'content' ? 'block' : 'none';
            document.getElementById('suggestFileTab').style.display = tab === 'file' ? 'block' : 'none';
        }

        let currentComplianceTab = 'content';
        function switchComplianceTab(tab) {
            currentComplianceTab = tab;
            document.querySelectorAll('#check-compliance .tabs .tab').forEach((t, i) => {
                t.classList.toggle('active', (tab === 'content' && i === 0) || (tab === 'file' && i === 1));
            });
            document.getElementById('complianceContentTab').style.display = tab === 'content' ? 'block' : 'none';
            document.getElementById('complianceFileTab').style.display = tab === 'file' ? 'block' : 'none';
        }

        let currentDuplicatesTab = 'content';
        function switchDuplicatesTab(tab) {
            currentDuplicatesTab = tab;
            document.querySelectorAll('#find-duplicates .tabs .tab').forEach((t, i) => {
                t.classList.toggle('active', (tab === 'content' && i === 0) || (tab === 'file' && i === 1));
            });
            document.getElementById('duplicatesContentTab').style.display = tab === 'content' ? 'block' : 'none';
            document.getElementById('duplicatesFileTab').style.display = tab === 'file' ? 'block' : 'none';
        }

        let currentContextTab = 'content';
        function switchContextTab(tab) {
            currentContextTab = tab;
            document.querySelectorAll('#verify-context .tabs .tab').forEach((t, i) => {
                t.classList.toggle('active', (tab === 'content' && i === 0) || (tab === 'file' && i === 1));
            });
            document.getElementById('contextContentTab').style.display = tab === 'content' ? 'block' : 'none';
            document.getElementById('contextFileTab').style.display = tab === 'file' ? 'block' : 'none';
        }

        let currentAuditTab = 'content';
        function switchAuditTab(tab) {
            currentAuditTab = tab;
            document.querySelectorAll('#audit .tabs .tab').forEach((t, i) => {
                t.classList.toggle('active', (tab === 'content' && i === 0) || (tab === 'file' && i === 1));
            });
            document.getElementById('auditContentTab').style.display = tab === 'content' ? 'block' : 'none';
            document.getElementById('auditFileTab').style.display = tab === 'file' ? 'block' : 'none';
        }

        async function processDocument() {
            const style = document.getElementById('docStyle').value;
            const container = document.getElementById('docResult');
            const saveToFile = document.getElementById('saveToFile')?.checked || false;
            const dryRun = document.getElementById('dryRun')?.checked || false;
            const multiSection = document.getElementById('multiSection')?.checked || false;
            const processOrphans = document.getElementById('processOrphans')?.checked || false;
            
            let requestBody = { style, dry_run: dryRun, multi_section: multiSection, process_orphans: processOrphans };
            
            if (currentDocTab === 'content') {
                const content = document.getElementById('docContent').value.trim();
                if (!content) {
                    showToast('Please paste document content', 'error');
                    return;
                }
                requestBody.content = content;
            } else {
                const filePath = document.getElementById('docFilePath').value.trim();
                if (!filePath) {
                    showToast('Please enter a file path', 'error');
                    return;
                }
                requestBody.file_path = filePath;
                // Don't save if dry run
                requestBody.save_to_file = dryRun ? false : saveToFile;
                requestBody.create_backup = !dryRun; // No backup needed for dry run
            }

            // Show progress UI
            container.innerHTML = `
                <div class="progress-container" style="padding: 20px 0;">
                    <div class="progress-header" style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span id="progressPhase" style="font-weight: 600; color: var(--accent);">üîÑ Initializing...</span>
                        <span id="progressPercent" style="color: var(--text-muted);">0%</span>
                    </div>
                    <div class="progress-bar-outer" style="height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                        <div id="progressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), #a78bfa); transition: width 0.3s ease;"></div>
                    </div>
                    <div id="progressMessage" style="margin-top: 8px; font-size: 0.9rem; color: var(--text-secondary);">Connecting...</div>
                    
                    <div class="live-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 20px;">
                        <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <div id="liveTotal" style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">-</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Total Refs</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <div id="liveProcessed" style="font-size: 1.5rem; font-weight: 700; color: var(--success);">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Processed</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <div id="liveFailed" style="font-size: 1.5rem; font-weight: 700; color: var(--text-muted);">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Failed</div>
                        </div>
                    </div>
                    
                    <div id="currentRef" style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; display: none;">
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">Currently processing:</div>
                        <div id="currentRefTitle" style="font-size: 0.9rem; color: var(--text-primary); font-family: 'JetBrains Mono', monospace;"></div>
                    </div>
                </div>
            `;
            
            // Use streaming endpoint for real-time progress
            const streamSuccess = await processDocumentWithProgress(requestBody, container);
            if (streamSuccess) return; // Streaming handled everything
            
            // Fallback to regular endpoint if streaming fails
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Processing document...</div>';

            try {
                const res = await fetch(`${API}/api/process-document`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await res.json();

                if (data.success) {
                    lastProcessedDoc = data.processed_content;
                    const stats = data.statistics || {};
                    const docStats = stats.document_analysis || {};
                    
                    container.innerHTML = `
                        <h4 style="margin: 20px 0 12px 0; color: var(--accent);">üìä Document Analysis</h4>
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-value">${docStats.total_inline_references ?? 0}</div>
                                <div class="stat-label">Inline References</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${docStats.total_citations ?? 0}</div>
                                <div class="stat-label">Citations in Doc</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${docStats.total_identifiers ?? 0}</div>
                                <div class="stat-label">Identifiers Found</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${docStats.markdown_links ?? 0}</div>
                                <div class="stat-label">Markdown Links</div>
                            </div>
                        </div>
                        
                        <details style="margin-bottom: 16px;">
                            <summary style="cursor: pointer; color: var(--accent); font-weight: 500;">üìã Detailed Breakdown</summary>
                            <div style="margin-top: 12px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; font-size: 0.9rem;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                    <div><strong>Inline References:</strong>
                                        <ul style="margin: 4px 0 0 20px; padding: 0;">
                                            <li>Numeric [1]: ${docStats.inline_numeric ?? 0}</li>
                                            <li>Footnote [^ref]: ${docStats.inline_footnote ?? 0}</li>
                                            <li>Author-year: ${docStats.inline_author_year ?? 0}</li>
                                        </ul>
                                    </div>
                                    <div><strong>Reference Section:</strong>
                                        <ul style="margin: 4px 0 0 20px; padding: 0;">
                                            <li>Items: ${docStats.reference_section_items ?? 0}</li>
                                            <li>Footnote defs: ${docStats.footnote_definitions ?? 0}</li>
                                        </ul>
                                    </div>
                                    <div><strong>Identifiers:</strong>
                                        <ul style="margin: 4px 0 0 20px; padding: 0;">
                                            <li>PubMed URLs: ${docStats.pubmed_urls ?? 0}</li>
                                            <li>DOI links: ${docStats.doi_links ?? 0}</li>
                                            <li>PMID mentions: ${docStats.pmid_mentions ?? 0}</li>
                                            <li>PMC IDs: ${docStats.pmcid_mentions ?? 0}</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </details>
                        
                        <h4 style="margin: 20px 0 12px 0; color: var(--accent);">‚öôÔ∏è Processing Results</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${stats.total_references ?? 0}</div>
                                <div class="stat-label">Total References</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: var(--success);">${stats.processed ?? 0}</div>
                                <div class="stat-label">‚úÖ Processed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: ${(stats.needs_review || 0) > 0 ? 'var(--warning)' : 'var(--text-muted)'};">${stats.needs_review ?? 0}</div>
                                <div class="stat-label">‚ö†Ô∏è Needs Review</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: ${(stats.failed || 0) > 0 ? 'var(--error)' : 'var(--text-muted)'};">${stats.failed ?? 0}</div>
                                <div class="stat-label">‚ùå Failed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: ${(stats.orphaned || 0) > 0 ? 'var(--text-muted)' : 'var(--text-muted)'};">${stats.orphaned ?? 0}</div>
                                <div class="stat-label">üóëÔ∏è Orphaned</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: ${(stats.duplicates_merged || 0) > 0 ? 'var(--accent)' : 'var(--text-muted)'};">${stats.duplicates_merged ?? 0}</div>
                                <div class="stat-label">üîó Duplicates Merged</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.inline_replacements ?? 0}</div>
                                <div class="stat-label">üîÑ Replacements</div>
                            </div>
                        </div>
                        ${data.dry_run ? `
                            <div class="message info" style="margin: 12px 0; padding: 16px; background: rgba(99, 102, 241, 0.1); border-left: 4px solid var(--accent);">
                                <span>üëÅÔ∏è</span>
                                <span><strong>DRY RUN MODE</strong> ‚Äî This is a preview only. No changes have been saved. Uncheck "Dry Run" to process and save.</span>
                            </div>
                        ` : ''}
                        ${data.multi_section ? `
                            <div class="message info" style="margin: 12px 0; padding: 12px; font-size: 0.9rem;">
                                <span>üìë</span>
                                <span>Multi-section mode: Reference sections were processed independently.</span>
                            </div>
                        ` : ''}
                        ${(stats.orphaned || 0) > 0 ? `
                            <div class="message info" style="margin: 12px 0; padding: 12px; font-size: 0.9rem;">
                                <span>üóëÔ∏è</span>
                                <span><strong>${stats.orphaned}</strong> orphaned reference(s) were found in the reference section but not cited in the document body. They have been moved to the "Unused References" section.</span>
                            </div>
                        ` : ''}
                        ${(stats.duplicates_merged || 0) > 0 ? `
                            <div class="message info" style="margin: 12px 0; padding: 12px; font-size: 0.9rem;">
                                <span>üîó</span>
                                <span><strong>${stats.duplicates_merged}</strong> duplicate reference(s) were detected and merged into single citations.</span>
                            </div>
                        ` : ''}
                        ${(stats.needs_review || 0) > 0 ? `
                            <div class="message warning" style="margin: 12px 0; padding: 12px; font-size: 0.9rem;">
                                <span>‚ö†Ô∏è</span>
                                <span><strong>${stats.needs_review}</strong> citation(s) may need manual review. Check the "Citations Requiring Review" section in the processed document.</span>
                            </div>
                        ` : ''}
                        ${data.saved_to_file ? `
                            <div class="message success" style="margin: 16px 0; padding: 16px;">
                                <span>üíæ</span>
                                <div style="flex: 1;">
                                    <strong>File saved successfully!</strong><br>
                                    <span style="font-size: 0.9rem;">üìÑ Saved to: <code>${escHtml(data.saved_path || '')}</code></span><br>
                                    ${data.backup_path ? `<span style="font-size: 0.9rem;">üì¶ Backup at: <code>${escHtml(data.backup_path)}</code></span>` : ''}
                                </div>
                            </div>
                            ${data.backup_path ? `
                            <details style="margin: 8px 0 16px 0; padding: 12px 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--warning);">
                                <summary style="cursor: pointer; font-weight: 600; color: var(--warning);">
                                    ‚ö†Ô∏è Need to undo? Click here for restore instructions
                                </summary>
                                <div style="margin-top: 12px; font-size: 0.9rem;">
                                    <p style="margin: 0 0 12px 0;">If you need to restore the original file, use one of these methods:</p>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <strong>Option 1: In Finder</strong>
                                        <ol style="margin: 4px 0 0 20px; padding: 0;">
                                            <li>Navigate to the backup file location</li>
                                            <li>Delete or rename the current file</li>
                                            <li>Rename the backup file (remove the _backup_YYYYMMDD_HHMMSS part)</li>
                                        </ol>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <strong>Option 2: Terminal command</strong>
                                        <div style="background: var(--bg-base); padding: 8px 12px; border-radius: 4px; margin-top: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; position: relative;">
                                            <code>cp "${escHtml(data.backup_path)}" "${escHtml(data.saved_path || '')}"</code>
                                            <button onclick="navigator.clipboard.writeText('cp \\'${escHtml(data.backup_path)}\\' \\'${escHtml(data.saved_path || '')}\\''); showToast('Restore command copied!', 'success');" 
                                                    style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: var(--accent); border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; color: white;">
                                                üìã Copy
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <p style="margin: 12px 0 0 0; color: var(--text-muted); font-size: 0.85rem;">
                                        üí° <strong>Tip:</strong> The backup file is saved in the same folder as your original document.
                                    </p>
                                </div>
                            </details>
                            ` : ''}
                        ` : data.backup_path && !data.saved_to_file ? `
                            <div class="message info" style="margin: 16px 0;">
                                <span>üì¶</span>
                                <span>Backup created: <code style="font-size: 0.85rem;">${escHtml(data.backup_path)}</code></span>
                            </div>
                        ` : ''}
                        ${data.save_error ? `
                            <div class="message error" style="margin: 16px 0;">
                                <span>‚ö†Ô∏è</span>
                                <span>Failed to save file: ${escHtml(data.save_error)}. Use "Download" to save manually.</span>
                            </div>
                        ` : ''}
                        ${(stats.total_references ?? 0) === 0 && (docStats.total_citations ?? 0) > 0 ? `
                            <div class="message success" style="margin: 16px 0;">
                                <span>‚úÖ</span>
                                <span>This document already has ${docStats.total_citations} formatted citations with ${docStats.total_inline_references} inline references. No processing needed!</span>
                            </div>
                        ` : (stats.total_references ?? 0) === 0 ? `
                            <div class="message info" style="margin: 16px 0;">
                                <span>üí°</span>
                                <span>No processable references found. Add PubMed URLs or citation markers to process.</span>
                            </div>
                        ` : ''}
                        ${data.failed_references && data.failed_references.length > 0 ? `
                            <div class="message error" style="margin-bottom: 16px;">
                                <span>‚ö†Ô∏è</span>
                                <span>Could not resolve: ${data.failed_references.map(r => `#${r.original_number}`).join(', ')}</span>
                            </div>
                        ` : ''}
                        <div class="result-box">
                            <div class="result-header">
                                <span class="result-label">Processed Document</span>
                            </div>
                            <div class="result-content">
                                <textarea readonly style="width: 100%; min-height: 400px; background: var(--bg-base); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 12px;">${escHtml(data.processed_content)}</textarea>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error || 'Processing failed')}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        async function restoreFromBackup(backupPath, targetPath) {
            console.log('Restore requested:', { backupPath, targetPath });
            
            if (!backupPath) {
                showToast('‚ùå No backup path available', 'error');
                return;
            }
            
            if (!confirm('Are you sure you want to restore the original file? This will overwrite the current processed version.')) {
                return;
            }
            
            try {
                // Server can infer target_path from backup_path if not provided
                const requestBody = { backup_path: backupPath };
                if (targetPath) {
                    requestBody.target_path = targetPath;
                }
                
                console.log('Sending restore request:', requestBody);
                
                const res = await fetch(`${API}/api/restore-backup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await res.json();
                console.log('Restore response:', data);
                
                if (data.success) {
                    showToast('‚úÖ Original file restored successfully!', 'success');
                    // Update the UI to reflect the restore
                    const container = document.getElementById('docResult');
                    container.innerHTML = `
                        <div class="message success" style="margin: 16px 0; padding: 16px;">
                            <span>‚úÖ</span>
                            <div>
                                <strong>Original file restored!</strong><br>
                                <span style="font-size: 0.9rem;">The file has been reverted to its original state before processing.</span><br>
                                <span style="font-size: 0.85rem; color: var(--text-muted);">Restored: ${escHtml(targetPath)}</span>
                            </div>
                        </div>
                        <div class="message info" style="margin-top: 8px;">
                            <span>üí°</span>
                            <span>You can process the document again if needed.</span>
                        </div>
                    `;
                } else {
                    showToast('‚ùå Restore failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                showToast('‚ùå Restore failed: ' + e.message, 'error');
            }
        }
        
        function copyProcessedDoc() {
            if (lastProcessedDoc) {
                copyText(lastProcessedDoc);
            } else {
                showToast('No processed document to copy', 'error');
            }
        }

        function downloadProcessedDoc() {
            if (!lastProcessedDoc) {
                showToast('No processed document to download', 'error');
                return;
            }
            const blob = new Blob([lastProcessedDoc], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'processed_document.md';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Utilities
        function copyText(text) {
            navigator.clipboard.writeText(text);
            showToast('Copied to clipboard!');
        }

        function copyResult() {
            if (!lastResult || !lastResult.success) return;
            const format = document.getElementById('formatSelect').value;
            let text = '';
            if (format === 'inline') text = lastResult.inline_mark;
            else if (format === 'endnote') text = lastResult.full_citation;
            else text = lastResult.inline_mark + '\n\n' + lastResult.full_citation;
            copyText(text);
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'error' ? 'var(--error)' : 'var(--success)';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        function escHtml(text) {
            if (!text) return '';
            return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function esc(text) {
            if (!text) return '';
            return String(text).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/`/g, '\\`').replace(/\$/g, '\\$');
        }

        // =====================================================
        // Folder Browser for Vault Selection
        // =====================================================
        
        let currentBrowsePath = '';
        let nativePickerAvailable = true; // Will be set false if native picker fails
        
        async function openFolderBrowser() {
            // Try native macOS folder picker first (since this is a local server)
            if (nativePickerAvailable) {
                try {
                    const res = await fetch(`${API}/api/pick-folder`);
                    const data = await res.json();
                    
                    if (data.success && data.path) {
                        document.getElementById('settingVaultPath').value = data.path;
                        
                        // Show feedback
                        const isVault = data.is_obsidian_vault ? ' (Obsidian Vault detected! ‚úì)' : '';
                        showNotification(`Selected: ${data.path}${isVault}`, 'success');
                        return;
                    } else if (data.cancelled) {
                        // User cancelled - do nothing
                        return;
                    } else if (data.error) {
                        // Native picker not available, fall back to modal
                        console.log('Native picker unavailable:', data.error);
                        nativePickerAvailable = false;
                    }
                } catch (e) {
                    console.log('Native picker error:', e);
                    nativePickerAvailable = false;
                }
            }
            
            // Fallback: Use custom modal browser
            document.getElementById('folderBrowserModal').style.display = 'flex';
            await loadDirectory();
        }
        
        function showNotification(message, type = 'info') {
            const msgEl = document.getElementById('settingsMessage');
            if (msgEl) {
                const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : 'üí°';
                msgEl.innerHTML = `<div class="message ${type}"><span>${icon}</span><span>${message}</span></div>`;
                setTimeout(() => { msgEl.innerHTML = ''; }, 5000);
            }
        }
        
        function closeFolderBrowser() {
            document.getElementById('folderBrowserModal').style.display = 'none';
        }
        
        async function loadDirectory(path = '') {
            const contentEl = document.getElementById('folderBrowserContent');
            const pathEl = document.getElementById('folderBrowserPath');
            const selectBtn = document.getElementById('selectFolderBtn');
            
            contentEl.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            
            try {
                const url = path 
                    ? `${API}/api/browse-directories?path=${encodeURIComponent(path)}`
                    : `${API}/api/browse-directories`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.error) {
                    contentEl.innerHTML = `<div class="message error"><span>‚ùå</span><span>${data.error}</span></div>`;
                    return;
                }
                
                currentBrowsePath = data.current;
                pathEl.textContent = data.current;
                
                // Enable select button if this is an Obsidian vault
                if (data.is_obsidian_vault) {
                    selectBtn.disabled = false;
                    selectBtn.innerHTML = '‚úì Select This Vault';
                    pathEl.innerHTML = `<span style="color: var(--accent);">üìö ${data.current}</span> <span style="background: var(--accent); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px;">Obsidian Vault</span>`;
                } else {
                    selectBtn.disabled = false;
                    selectBtn.innerHTML = '‚úì Select This Folder';
                }
                
                let html = '';
                
                // Parent directory navigation
                if (data.parent) {
                    html += `
                        <div class="folder-nav" onclick="loadDirectory('${escapeHtml(data.parent)}')">
                            <span class="icon">‚¨ÜÔ∏è</span>
                            <span>Go to parent folder</span>
                        </div>
                    `;
                }
                
                // List directories
                if (data.directories && data.directories.length > 0) {
                    for (const dir of data.directories) {
                        const vaultClass = dir.is_obsidian_vault ? 'vault' : '';
                        const badge = dir.is_obsidian_vault ? '<span class="badge">Vault</span>' : '';
                        const icon = dir.is_obsidian_vault ? 'üìö' : 'üìÅ';
                        
                        html += `
                            <div class="folder-item ${vaultClass}" onclick="loadDirectory('${escapeHtml(dir.path)}')">
                                <span class="icon">${icon}</span>
                                <span class="name">${escapeHtml(dir.name)}</span>
                                ${badge}
                            </div>
                        `;
                    }
                } else {
                    html += `
                        <div class="empty-folder">
                            <p>üì≠ No subdirectories</p>
                            <p style="font-size: 0.85rem;">You can still select this folder</p>
                        </div>
                    `;
                }
                
                contentEl.innerHTML = html;
                
            } catch (e) {
                contentEl.innerHTML = `<div class="message error"><span>‚ùå</span><span>Error: ${e.message}</span></div>`;
            }
        }
        
        function selectCurrentFolder() {
            if (currentBrowsePath) {
                document.getElementById('settingVaultPath').value = currentBrowsePath;
                closeFolderBrowser();
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, "\\'");
        }
        
        // Close modal when clicking outside
        document.getElementById('folderBrowserModal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeFolderBrowser();
            }
        });

        // =====================================================
        // Settings Page
        // =====================================================
        let settingsLoaded = false;

        async function loadSettings() {
            const loadingEl = document.getElementById('settingsContent');
            const formEl = document.getElementById('settingsForm');
            
            try {
                const res = await fetch(`${API}/api/settings`);
                const data = await res.json();
                
                if (data.settings) {
                    // Populate form fields
                    document.getElementById('settingVaultPath').value = data.settings.obsidian_vault_path || '';
                    document.getElementById('settingDefaultStyle').value = data.settings.default_citation_style || 'vancouver';
                    document.getElementById('settingCreateBackup').checked = data.settings.create_backup_on_process !== false;
                    document.getElementById('settingVerifyLinks').checked = data.settings.verify_links_by_default !== false;
                    document.getElementById('settingSuggestCitations').checked = data.settings.suggest_citations_by_default !== false;
                    document.getElementById('settingCheckCompliance').checked = data.settings.check_compliance_by_default !== false;
                    document.getElementById('settingEnableLLM').checked = data.settings.enable_llm_extraction !== false;
                    document.getElementById('settingMaxResults').value = data.settings.max_search_results || 10;
                    
                    // Show form, hide loading
                    loadingEl.style.display = 'none';
                    formEl.style.display = 'block';
                    settingsLoaded = true;
                }
            } catch (e) {
                loadingEl.innerHTML = `<div class="message error"><span>‚ùå</span><span>Failed to load settings: ${e.message}</span></div>`;
            }
        }

        async function saveSettings() {
            const msgEl = document.getElementById('settingsMessage');
            msgEl.innerHTML = '<div class="loading"><div class="spinner"></div>Saving...</div>';
            
            const settings = {
                obsidian_vault_path: document.getElementById('settingVaultPath').value.trim(),
                default_citation_style: document.getElementById('settingDefaultStyle').value,
                create_backup_on_process: document.getElementById('settingCreateBackup').checked,
                verify_links_by_default: document.getElementById('settingVerifyLinks').checked,
                suggest_citations_by_default: document.getElementById('settingSuggestCitations').checked,
                check_compliance_by_default: document.getElementById('settingCheckCompliance').checked,
                enable_llm_extraction: document.getElementById('settingEnableLLM').checked,
                max_search_results: parseInt(document.getElementById('settingMaxResults').value) || 10,
            };
            
            try {
                const res = await fetch(`${API}/api/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings),
                });
                const data = await res.json();
                
                if (data.success) {
                    msgEl.innerHTML = '<div class="message success"><span>‚úÖ</span><span>Settings saved! Changes will sync to Obsidian plugin on next Pull.</span></div>';
                    // Update vault hint on process page
                    loadVaultConfig();
                } else {
                    msgEl.innerHTML = `<div class="message error"><span>‚ùå</span><span>${data.error || 'Failed to save'}</span></div>`;
                }
            } catch (e) {
                msgEl.innerHTML = `<div class="message error"><span>‚ùå</span><span>Error: ${e.message}</span></div>`;
            }
            
            // Clear message after 6 seconds
            setTimeout(() => { msgEl.innerHTML = ''; }, 6000);
        }

        async function resetSettings() {
            if (!confirm('Are you sure you want to reset all settings to defaults?')) return;
            
            const msgEl = document.getElementById('settingsMessage');
            msgEl.innerHTML = '<div class="loading"><div class="spinner"></div>Resetting...</div>';
            
            try {
                const res = await fetch(`${API}/api/settings/reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });
                const data = await res.json();
                
                if (data.success) {
                    msgEl.innerHTML = '<div class="message success"><span>‚úÖ</span><span>Settings reset to defaults!</span></div>';
                    // Reload the form
                    settingsLoaded = false;
                    loadSettings();
                    loadVaultConfig();
                } else {
                    msgEl.innerHTML = `<div class="message error"><span>‚ùå</span><span>${data.error || 'Failed to reset'}</span></div>`;
                }
            } catch (e) {
                msgEl.innerHTML = `<div class="message error"><span>‚ùå</span><span>Error: ${e.message}</span></div>`;
            }
            
            setTimeout(() => { msgEl.innerHTML = ''; }, 5000);
        }

        // === Document Intelligence Functions ===
        
        async function verifyLinks() {
            const body = {};
            
            if (currentVerifyLinksTab === 'content') {
                const content = document.getElementById('verifyLinksInput').value.trim();
                if (!content) {
                    alert('Please enter document content to verify.');
                    return;
                }
                body.content = content;
            } else if (currentVerifyLinksTab === 'file') {
                const filePath = document.getElementById('verifyLinksFilePath').value.trim();
                if (!filePath) {
                    alert('Please enter a file path.');
                    return;
                }
                body.file_path = filePath;
            } else if (currentVerifyLinksTab === 'urls') {
                const urlsText = document.getElementById('verifyLinksUrls').value.trim();
                if (!urlsText) {
                    alert('Please enter URLs to verify.');
                    return;
                }
                body.urls = urlsText.split('\n').map(u => u.trim()).filter(u => u);
            }
            
            const resultCard = document.getElementById('verifyLinksResult');
            const resultContent = document.getElementById('verifyLinksContent');
            resultCard.style.display = 'block';
            resultContent.innerHTML = '<div class="loading"><div class="spinner"></div>Verifying links...</div>';
            
            try {
                
                const res = await fetch(`${API}/api/verify-links`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await res.json();
                
                if (data.error) {
                    resultContent.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error)}</div>`;
                    return;
                }
                
                let html = `<div class="stats-row" style="margin-bottom: 20px;">
                    <div class="stat-card"><div class="stat-value">${data.total_urls || data.verified || 0}</div><div class="stat-label">URLs Checked</div></div>
                    <div class="stat-card"><div class="stat-value" style="color: var(--success);">${data.status_summary?.ok || 0}</div><div class="stat-label">‚úÖ OK</div></div>
                    <div class="stat-card"><div class="stat-value" style="color: var(--error);">${data.status_summary?.broken || 0}</div><div class="stat-label">‚ùå Broken</div></div>
                </div>`;
                
                if (data.broken_links?.length > 0) {
                    html += '<h4>‚ùå Broken Links</h4><ul>';
                    for (const link of data.broken_links) {
                        html += `<li><code>${escHtml(link.url)}</code>`;
                        if (link.archived_url) html += ` <a href="${escHtml(link.archived_url)}" target="_blank">üì¶ Archive</a>`;
                        html += '</li>';
                    }
                    html += '</ul>';
                }
                
                resultContent.innerHTML = html || '<div class="message success">‚úÖ All links are working!</div>';
            } catch (e) {
                resultContent.innerHTML = `<div class="message error">‚ùå Error: ${escHtml(e.message)}</div>`;
            }
        }
        
        async function suggestCitations() {
            const searchPubMed = document.getElementById('searchPubMedSuggestions').checked;
            const body = { search_pubmed: searchPubMed };
            
            if (currentSuggestTab === 'content') {
                const content = document.getElementById('suggestCitationsInput').value.trim();
                if (!content) {
                    alert('Please enter document content.');
                    return;
                }
                body.content = content;
            } else {
                const filePath = document.getElementById('suggestFilePath').value.trim();
                if (!filePath) {
                    alert('Please enter a file path.');
                    return;
                }
                body.file_path = filePath;
            }
            
            const resultCard = document.getElementById('suggestCitationsResult');
            const resultContent = document.getElementById('suggestCitationsContent');
            resultCard.style.display = 'block';
            resultContent.innerHTML = '<div class="loading"><div class="spinner"></div>Analyzing document for citation opportunities...</div>';
            
            try {
                
                const res = await fetch(`${API}/api/suggest-citations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await res.json();
                
                if (data.error) {
                    resultContent.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error)}</div>`;
                    return;
                }
                
                if (!data.count || data.count === 0) {
                    resultContent.innerHTML = '<div class="message success">‚úÖ No obvious missing citations detected.</div>';
                    return;
                }
                
                let html = `<p><strong>${data.count}</strong> passage(s) may need citations:</p>`;
                for (const s of data.suggestions || []) {
                    const emoji = {statistic: 'üìä', claim: 'üí¨', definition: 'üìñ', finding: 'üî¨'}[s.category] || 'üìù';
                    html += `<div class="result-item" style="margin-bottom: 16px;">
                        <strong>${emoji} Line ${s.line_number}</strong> (${Math.round(s.confidence * 100)}% confidence)<br>
                        <blockquote style="margin: 8px 0; padding: 8px; background: var(--bg-secondary); border-radius: 4px;">${escHtml(s.text_excerpt)}</blockquote>
                        <em>${escHtml(s.reason)}</em>
                    </div>`;
                }
                resultContent.innerHTML = html;
            } catch (e) {
                resultContent.innerHTML = `<div class="message error">‚ùå Error: ${escHtml(e.message)}</div>`;
            }
        }
        
        async function checkCompliance() {
            const body = {};
            
            if (currentComplianceTab === 'content') {
                const content = document.getElementById('checkComplianceInput').value.trim();
                if (!content) {
                    alert('Please enter document content.');
                    return;
                }
                body.content = content;
            } else {
                const filePath = document.getElementById('complianceFilePath').value.trim();
                if (!filePath) {
                    alert('Please enter a file path.');
                    return;
                }
                body.file_path = filePath;
            }
            
            const resultCard = document.getElementById('checkComplianceResult');
            const resultContent = document.getElementById('checkComplianceContent');
            resultCard.style.display = 'block';
            resultContent.innerHTML = '<div class="loading"><div class="spinner"></div>Checking citation compliance...</div>';
            
            try {
                
                const res = await fetch(`${API}/api/check-compliance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await res.json();
                
                if (data.error) {
                    resultContent.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error)}</div>`;
                    return;
                }
                
                const score = data.compliance_score || 100;
                const scoreColor = score >= 80 ? 'var(--success)' : score >= 60 ? 'var(--warning)' : 'var(--error)';
                const scoreEmoji = score >= 80 ? 'üü¢' : score >= 60 ? 'üü°' : 'üî¥';
                
                let html = `<div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3rem; font-weight: bold; color: ${scoreColor};">${scoreEmoji} ${score}/100</div>
                    <div style="color: var(--text-muted);">Compliance Score</div>
                </div>`;
                
                html += `<div class="stats-row" style="margin-bottom: 20px;">
                    <div class="stat-card"><div class="stat-value">${data.total_issues || 0}</div><div class="stat-label">Total Issues</div></div>
                    <div class="stat-card"><div class="stat-value" style="color: var(--error);">${data.high_severity_count || 0}</div><div class="stat-label">üî¥ High</div></div>
                    <div class="stat-card"><div class="stat-value" style="color: var(--warning);">${data.medium_severity_count || 0}</div><div class="stat-label">üü° Medium</div></div>
                </div>`;
                
                if (data.issues?.length > 0) {
                    html += '<h4>Issues Found</h4>';
                    for (const issue of data.issues) {
                        const severity = {high: 'üî¥', medium: 'üü°', low: 'üü¢'}[issue.severity] || '‚ö™';
                        html += `<div class="result-item" style="margin-bottom: 12px;">
                            <strong>${severity} Line ${issue.line_number}</strong><br>
                            <code style="font-size: 0.9rem;">${escHtml((issue.text || '').substring(0, 100))}...</code><br>
                            <em>${escHtml(issue.explanation)}</em>
                        </div>`;
                    }
                }
                
                resultContent.innerHTML = html;
            } catch (e) {
                resultContent.innerHTML = `<div class="message error">‚ùå Error: ${escHtml(e.message)}</div>`;
            }
        }
        
        async function findDuplicates() {
            const autoFix = document.getElementById('autoFixDuplicates').checked;
            const body = { auto_fix: autoFix };
            
            if (currentDuplicatesTab === 'content') {
                const content = document.getElementById('findDuplicatesInput').value.trim();
                if (!content) {
                    alert('Please enter document content.');
                    return;
                }
                body.content = content;
            } else {
                const filePath = document.getElementById('duplicatesFilePath').value.trim();
                if (!filePath) {
                    alert('Please enter a file path.');
                    return;
                }
                body.file_path = filePath;
            }
            
            const resultCard = document.getElementById('findDuplicatesResult');
            const resultContent = document.getElementById('findDuplicatesContent');
            resultCard.style.display = 'block';
            resultContent.innerHTML = '<div class="loading"><div class="spinner"></div>Checking citation integrity...</div>';
            
            try {
                
                const res = await fetch(`${API}/api/find-duplicates`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await res.json();
                
                if (data.error) {
                    resultContent.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error)}</div>`;
                    return;
                }
                
                if (data.is_clean) {
                    resultContent.innerHTML = '<div class="message success">‚úÖ No integrity issues found. Document citations are clean.</div>';
                    return;
                }
                
                let html = `<div class="stats-row" style="margin-bottom: 20px;">
                    <div class="stat-card"><div class="stat-value">${data.total_issues || 0}</div><div class="stat-label">Total Issues</div></div>
                    <div class="stat-card"><div class="stat-value">${(data.same_citation_duplicates || []).length}</div><div class="stat-label">Duplicates</div></div>
                    <div class="stat-card"><div class="stat-value">${(data.orphaned_definitions || []).length}</div><div class="stat-label">Orphans</div></div>
                    <div class="stat-card"><div class="stat-value">${(data.missing_definitions || []).length}</div><div class="stat-label">Missing</div></div>
                </div>`;
                
                if (data.same_citation_duplicates?.length > 0) {
                    html += '<h4>‚ùå Consecutive Duplicates</h4><ul>';
                    for (const d of data.same_citation_duplicates) {
                        html += `<li>Line ${d.line}: <code>${escHtml(d.original)}</code> ‚Üí <code>${escHtml(d.fix)}</code></li>`;
                    }
                    html += '</ul>';
                }
                
                if (data.orphaned_definitions?.length > 0) {
                    html += '<h4>‚ö†Ô∏è Orphaned Definitions</h4><p>Defined but never used:</p><ul>';
                    for (const o of data.orphaned_definitions.slice(0, 15)) {
                        html += `<li><code>${escHtml(o)}</code></li>`;
                    }
                    if (data.orphaned_definitions.length > 15) html += `<li>...and ${data.orphaned_definitions.length - 15} more</li>`;
                    html += '</ul>';
                }
                
                if (data.missing_definitions?.length > 0) {
                    html += '<h4>‚ùå Missing Definitions</h4><p>Used but never defined:</p><ul>';
                    for (const m of data.missing_definitions.slice(0, 15)) {
                        html += `<li><code>${escHtml(m)}</code></li>`;
                    }
                    if (data.missing_definitions.length > 15) html += `<li>...and ${data.missing_definitions.length - 15} more</li>`;
                    html += '</ul>';
                }
                
                if (data.fixes_applied) {
                    html += `<div class="message success">‚úÖ Auto-fixed ${data.fixes_applied} duplicate(s)!</div>`;
                }
                
                resultContent.innerHTML = html;
            } catch (e) {
                resultContent.innerHTML = `<div class="message error">‚ùå Error: ${escHtml(e.message)}</div>`;
            }
        }
        
        function copyDuplicatesResult() {
            const content = document.getElementById('findDuplicatesContent').innerText;
            navigator.clipboard.writeText(content);
        }
        
        // Normalize Citations
        async function doNormalize() {
            const input = document.getElementById('normalizeInput').value.trim();
            const dryRun = document.getElementById('normalizeDryRun').checked;
            
            if (!input) {
                alert('Please enter content to normalize.');
                return;
            }
            
            const resultCard = document.getElementById('normalizeResult');
            const resultOutput = document.getElementById('normalizeOutput');
            resultCard.style.display = 'block';
            resultOutput.innerHTML = '<div class="loading"><div class="spinner"></div>Normalizing citations...</div>';
            
            try {
                const body = { dry_run: dryRun };
                if (input.startsWith('/') || input.includes(':\\')) {
                    body.file_path = input;
                } else {
                    body.content = input;
                }
                
                const res = await fetch(`${API}/api/normalize-format`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await res.json();
                
                if (data.error) {
                    resultOutput.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error)}</div>`;
                    return;
                }
                
                const badge = document.querySelector('#normalizeResult .result-badge');
                if (data.changes_made === 0) {
                    badge.textContent = 'No Changes';
                    badge.className = 'result-badge result-badge-muted';
                    resultOutput.innerHTML = `<div class="message success">‚úÖ No legacy citation formats found. Content is already normalized.</div>`;
                } else {
                    badge.textContent = `${data.changes_made} Normalized`;
                    badge.className = 'result-badge result-badge-success';
                    resultOutput.textContent = data.content || data.normalized_content || '';
                }
            } catch (e) {
                resultOutput.innerHTML = `<div class="message error">‚ùå Error: ${escHtml(e.message)}</div>`;
            }
        }
        
        function clearNormalize() {
            document.getElementById('normalizeInput').value = '';
            document.getElementById('normalizeResult').style.display = 'none';
        }
        
        function copyNormalizeResult() {
            const content = document.getElementById('normalizeOutput').innerText;
            navigator.clipboard.writeText(content);
        }
        
        // Library Hygiene - Article Duplicates
        async function doCheckArticleDuplicates() {
            const input = document.getElementById('articleDuplicatesInput').value.trim();
            
            if (!input) {
                alert('Please enter identifiers or bibliography content.');
                return;
            }
            
            const resultCard = document.getElementById('articleDuplicatesResult');
            const resultOutput = document.getElementById('articleDuplicatesOutput');
            const badge = document.getElementById('articleDuplicatesBadge');
            resultCard.style.display = 'block';
            resultOutput.innerHTML = '<div class="loading"><div class="spinner"></div>Checking for duplicate articles...</div>';
            
            try {
                // Parse input - could be one ID per line or a bibliography
                const lines = input.split('\n').map(l => l.trim()).filter(l => l);
                const identifiers = [];
                
                for (const line of lines) {
                    // Extract PMIDs, DOIs, PMCIDs from line
                    if (/^\d+$/.test(line)) {
                        identifiers.push(line); // PMID
                    } else if (line.includes('10.')) {
                        const doiMatch = line.match(/10\.\d+\/[^\s]+/);
                        if (doiMatch) identifiers.push(doiMatch[0]);
                    } else if (/PMC\d+/i.test(line)) {
                        const pmcMatch = line.match(/PMC\d+/i);
                        if (pmcMatch) identifiers.push(pmcMatch[0]);
                    } else if (line.length > 5) {
                        identifiers.push(line);
                    }
                }
                
                const res = await fetch(`${API}/api/check-article-duplicates`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifiers }),
                });
                const data = await res.json();
                
                if (data.error) {
                    resultOutput.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error)}</div>`;
                    return;
                }
                
                const duplicateCount = data.duplicate_groups?.length || 0;
                
                if (duplicateCount === 0) {
                    badge.textContent = 'Clean';
                    badge.className = 'result-badge result-badge-success';
                    resultOutput.innerHTML = `<div class="message success">‚úÖ No duplicate articles found! Checked ${data.total_checked || identifiers.length} identifiers.</div>`;
                } else {
                    badge.textContent = `${duplicateCount} Duplicates`;
                    badge.className = 'result-badge result-badge-warning';
                    
                    let html = `<div class="message warning">‚ö†Ô∏è Found ${duplicateCount} duplicate article group(s)</div>`;
                    html += '<h4 style="margin-top: 16px;">Duplicate Groups</h4>';
                    
                    for (const group of data.duplicate_groups) {
                        html += `<div class="result-item" style="margin-bottom: 16px; border-left: 3px solid var(--warning); padding-left: 12px;">`;
                        html += `<strong>${escHtml(group.title || 'Unknown Title')}</strong><br>`;
                        html += `<small>Found ${group.identifiers?.length || 0} times: ${(group.identifiers || []).map(id => `<code>${escHtml(id)}</code>`).join(', ')}</small>`;
                        html += `</div>`;
                    }
                    
                    resultOutput.innerHTML = html;
                }
            } catch (e) {
                resultOutput.innerHTML = `<div class="message error">‚ùå Error: ${escHtml(e.message)}</div>`;
            }
        }
        
        function clearArticleDuplicates() {
            document.getElementById('articleDuplicatesInput').value = '';
            document.getElementById('articleDuplicatesResult').style.display = 'none';
        }
        
        async function verifyContext() {
            const threshold = parseFloat(document.getElementById('contextThreshold').value) || 0.15;
            const deepVerify = document.getElementById('deepVerify').checked;
            const body = { threshold, deep_verify: deepVerify };
            
            if (currentContextTab === 'content') {
                const content = document.getElementById('verifyContextInput').value.trim();
                if (!content) {
                    alert('Please enter document content.');
                    return;
                }
                body.content = content;
            } else {
                const filePath = document.getElementById('contextFilePath').value.trim();
                if (!filePath) {
                    alert('Please enter a file path.');
                    return;
                }
                body.file_path = filePath;
            }
            
            const resultCard = document.getElementById('verifyContextResult');
            const resultContent = document.getElementById('verifyContextContent');
            resultCard.style.display = 'block';
            resultContent.innerHTML = '<div class="loading"><div class="spinner"></div>Verifying citation contexts...</div>';
            
            try {
                
                const res = await fetch(`${API}/api/verify-context`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await res.json();
                
                if (data.error) {
                    resultContent.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error)}</div>`;
                    return;
                }
                
                if (data.mismatches_found === 0) {
                    resultContent.innerHTML = `<div class="message success">‚úÖ All citations match their context! (Verified ${data.total_verified} citations)</div>`;
                    return;
                }
                
                let html = `<div class="stats-row" style="margin-bottom: 20px;">
                    <div class="stat-card"><div class="stat-value">${data.total_verified || 0}</div><div class="stat-label">Citations Verified</div></div>
                    <div class="stat-card"><div class="stat-value" style="color: var(--warning);">${data.mismatches_found || 0}</div><div class="stat-label">‚ö†Ô∏è Mismatches</div></div>
                </div>`;
                
                html += '<h4>Potential Context Mismatches</h4>';
                for (const m of data.mismatches || []) {
                    const concern = m.concern_level?.toUpperCase() || 'MODERATE';
                    const color = concern === 'HIGH' ? 'var(--error)' : concern === 'MODERATE' ? 'var(--warning)' : 'var(--text-muted)';
                    const emoji = concern === 'HIGH' ? 'üî¥' : concern === 'MODERATE' ? 'üü°' : 'üü¢';
                    
                    html += `<div class="result-item" style="margin-bottom: 16px; border-left: 3px solid ${color}; padding-left: 12px;">
                        <strong>${emoji} Line ${m.line_number}: <code>${escHtml(m.citation_tag)}</code></strong>
                        <span style="color: ${color};">(${Math.round(m.overlap_score * 100)}% overlap)</span><br>
                        <small>Citation keywords: ${(m.citation_keywords || []).join(', ')}</small><br>
                        <small>Context keywords: ${(m.context_keywords || []).join(', ')}</small>
                        ${m.deep_verify_result ? `<br><em>LLM: ${escHtml(m.deep_verify_result)}</em>` : ''}
                    </div>`;
                }
                
                resultContent.innerHTML = html;
            } catch (e) {
                resultContent.innerHTML = `<div class="message error">‚ùå Error: ${escHtml(e.message)}</div>`;
            }
        }
        
        function copyContextResult() {
            const content = document.getElementById('verifyContextContent').innerText;
            navigator.clipboard.writeText(content);
        }
        
        async function auditDocument() {
            const autoFix = document.getElementById('auditAutoFix').checked;
            const deepVerify = document.getElementById('auditDeepVerify').checked;
            const body = { auto_fix_duplicates: autoFix, deep_verify: deepVerify };
            
            if (currentAuditTab === 'content') {
                const content = document.getElementById('auditInput').value.trim();
                if (!content) {
                    alert('Please enter document content.');
                    return;
                }
                body.content = content;
            } else {
                const filePath = document.getElementById('auditFilePath').value.trim();
                if (!filePath) {
                    alert('Please enter a file path.');
                    return;
                }
                body.file_path = filePath;
            }
            
            const resultCard = document.getElementById('auditResult');
            const auditContent = document.getElementById('auditContent');
            const healthScoreEl = document.getElementById('auditHealthScore');
            resultCard.style.display = 'block';
            healthScoreEl.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            auditContent.innerHTML = '<div class="loading"><div class="spinner"></div>Running comprehensive audit...</div>';
            
            try {
                
                const res = await fetch(`${API}/api/audit-document`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await res.json();
                
                if (data.error) {
                    healthScoreEl.innerHTML = '';
                    auditContent.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error)}</div>`;
                    return;
                }
                
                const score = data.health_score || 100;
                const scoreColor = score >= 80 ? 'var(--success)' : score >= 60 ? 'var(--warning)' : 'var(--error)';
                const scoreEmoji = score >= 80 ? 'üü¢' : score >= 60 ? 'üü°' : 'üî¥';
                
                healthScoreEl.innerHTML = `
                    <div style="font-size: 3rem; font-weight: bold; color: ${scoreColor};">${scoreEmoji} ${score}/100</div>
                    <div style="color: var(--text-muted);">Health Score</div>
                `;
                
                const integrity = data.integrity || {};
                const context = data.context_verification || {};
                
                let html = `<div class="stats-row" style="margin-bottom: 20px;">
                    <div class="stat-card"><div class="stat-value">${integrity.same_citation_duplicates || 0}</div><div class="stat-label">Duplicates</div></div>
                    <div class="stat-card"><div class="stat-value">${integrity.orphaned_definitions || 0}</div><div class="stat-label">Orphans</div></div>
                    <div class="stat-card"><div class="stat-value">${integrity.missing_definitions || 0}</div><div class="stat-label">Missing</div></div>
                    <div class="stat-card"><div class="stat-value">${context.mismatches_found || 0}</div><div class="stat-label">Context Issues</div></div>
                </div>`;
                
                if (integrity.is_clean && context.mismatches_found === 0) {
                    html += '<div class="message success">‚úÖ Document passed all audit checks!</div>';
                } else {
                    if (integrity.same_citation_duplicates > 0) {
                        html += `<p>‚ùå <strong>${integrity.same_citation_duplicates}</strong> consecutive duplicate citations found</p>`;
                    }
                    if (integrity.orphaned_definitions > 0) {
                        html += `<p>‚ö†Ô∏è <strong>${integrity.orphaned_definitions}</strong> orphaned definitions (defined but never used)</p>`;
                    }
                    if (integrity.missing_definitions > 0) {
                        html += `<p>‚ùå <strong>${integrity.missing_definitions}</strong> missing definitions (used but never defined)</p>`;
                    }
                    if (context.high_concern > 0) {
                        html += `<p>üî¥ <strong>${context.high_concern}</strong> high-concern context mismatches</p>`;
                    }
                    if (context.moderate_concern > 0) {
                        html += `<p>üü° <strong>${context.moderate_concern}</strong> moderate-concern context mismatches</p>`;
                    }
                }
                
                if (data.fixes_applied) {
                    html += `<div class="message success">‚úÖ Auto-fixed ${data.fixes_applied} duplicate(s)!</div>`;
                }
                
                auditContent.innerHTML = html;
            } catch (e) {
                healthScoreEl.innerHTML = '';
                auditContent.innerHTML = `<div class="message error">‚ùå Error: ${escHtml(e.message)}</div>`;
            }
        }
        
        function copyAuditResult() {
            const content = document.getElementById('auditContent').innerText;
            navigator.clipboard.writeText(content);
        }

        // About Page
        let aboutLoaded = false;

        async function loadAbout() {
            if (aboutLoaded) return;
            
            const container = document.getElementById('aboutContent');
            
            try {
                const res = await fetch(`${API}/api/about`);
                const data = await res.json();
                
                if (data.content) {
                    const html = renderMarkdown(data.content);
                    container.innerHTML = `
                        <div class="about-quick-links">
                            <a href="#features">‚ú® Features</a>
                            <a href="#quick-start">üöÄ Quick Start</a>
                            <a href="#tools-overview">üìñ Tools</a>
                            <a href="#obsidian-plugin">üîå Obsidian Plugin</a>
                            <a href="#mcp-server">ü§ñ MCP Server</a>
                            <a href="https://github.com/shah0006/CitationSculptor" target="_blank">üì¶ GitHub</a>
                        </div>
                        <div class="markdown-content">${html}</div>
                    `;
                    aboutLoaded = true;
                } else {
                    container.innerHTML = `<div class="message error">‚ùå ${escHtml(data.error || 'Could not load documentation')}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="message error">‚ùå ${escHtml(e.message)}</div>`;
            }
        }

        function renderMarkdown(md) {
            // Process markdown into HTML
            let lines = md.split('\n');
            let html = [];
            let inCodeBlock = false;
            let codeContent = [];
            let codeLang = '';
            let inTable = false;
            let tableRows = [];
            let inList = false;
            let listItems = [];
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                
                // Code blocks
                if (line.startsWith('```')) {
                    if (inCodeBlock) {
                        html.push(`<pre><code class="language-${codeLang}">${escHtml(codeContent.join('\n'))}</code></pre>`);
                        codeContent = [];
                        codeLang = '';
                        inCodeBlock = false;
                    } else {
                        inCodeBlock = true;
                        codeLang = line.slice(3).trim();
                    }
                    continue;
                }
                
                if (inCodeBlock) {
                    codeContent.push(line);
                    continue;
                }
                
                // Tables
                if (line.startsWith('|') && line.endsWith('|')) {
                    const cells = line.split('|').filter(c => c.trim());
                    if (cells.every(c => /^[-:\s]+$/.test(c))) {
                        continue; // Skip separator row
                    }
                    if (!inTable) {
                        inTable = true;
                        tableRows = [];
                    }
                    tableRows.push(cells.map(c => c.trim()));
                    continue;
                } else if (inTable) {
                    // End table
                    let tableHtml = '<table>';
                    tableRows.forEach((row, idx) => {
                        const tag = idx === 0 ? 'th' : 'td';
                        tableHtml += '<tr>' + row.map(c => `<${tag}>${processInline(c)}</${tag}>`).join('') + '</tr>';
                    });
                    tableHtml += '</table>';
                    html.push(tableHtml);
                    inTable = false;
                    tableRows = [];
                }
                
                // Lists
                if (line.match(/^[-*] .+/) || line.match(/^\d+\. .+/)) {
                    const content = line.replace(/^[-*]\s+/, '').replace(/^\d+\.\s+/, '');
                    if (!inList) {
                        inList = true;
                        listItems = [];
                    }
                    listItems.push(processInline(content));
                    continue;
                } else if (inList && line.trim() === '') {
                    html.push('<ul>' + listItems.map(li => `<li>${li}</li>`).join('') + '</ul>');
                    inList = false;
                    listItems = [];
                    continue;
                } else if (inList) {
                    html.push('<ul>' + listItems.map(li => `<li>${li}</li>`).join('') + '</ul>');
                    inList = false;
                    listItems = [];
                }
                
                // Skip empty lines (we'll handle spacing via CSS)
                if (line.trim() === '') continue;
                
                // Horizontal rules
                if (line.match(/^---+$/)) {
                    html.push('<hr>');
                    continue;
                }
                
                // Headers
                if (line.startsWith('#### ')) {
                    html.push(`<h4>${processInline(line.slice(5))}</h4>`);
                    continue;
                }
                if (line.startsWith('### ')) {
                    html.push(`<h3>${processInline(line.slice(4))}</h3>`);
                    continue;
                }
                if (line.startsWith('## ')) {
                    const title = line.slice(3);
                    const id = title.toLowerCase().replace(/[^\w]+/g, '-').replace(/^-|-$/g, '');
                    html.push(`<h2 id="${id}">${processInline(title)}</h2>`);
                    continue;
                }
                if (line.startsWith('# ')) {
                    html.push(`<h1>${processInline(line.slice(2))}</h1>`);
                    continue;
                }
                
                // Blockquotes
                if (line.startsWith('> ')) {
                    html.push(`<blockquote>${processInline(line.slice(2))}</blockquote>`);
                    continue;
                }
                
                // Regular paragraph
                html.push(`<p>${processInline(line)}</p>`);
            }
            
            // Close any remaining open blocks
            if (inList) {
                html.push('<ul>' + listItems.map(li => `<li>${li}</li>`).join('') + '</ul>');
            }
            if (inTable) {
                let tableHtml = '<table>';
                tableRows.forEach((row, idx) => {
                    const tag = idx === 0 ? 'th' : 'td';
                    tableHtml += '<tr>' + row.map(c => `<${tag}>${processInline(c)}</${tag}>`).join('') + '</tr>';
                });
                tableHtml += '</table>';
                html.push(tableHtml);
            }
            
            return html.join('\n');
        }
        
        function processInline(text) {
            // Process inline markdown elements
            let result = text;
            
            // Images first (before links)
            result = result.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">');
            
            // Links
            result = result.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // Bold + italic
            result = result.replace(/\*\*\*([^*]+)\*\*\*/g, '<strong><em>$1</em></strong>');
            
            // Bold
            result = result.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Italic
            result = result.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // Inline code
            result = result.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            return result;
        }

        // Init
        checkServer();
        setInterval(checkServer, 30000);

        // Load library when that page is opened
        document.querySelector('[data-page="library"]').addEventListener('click', loadLibrary);

        // Load settings when that page is opened
        document.querySelector('[data-page="settings"]').addEventListener('click', loadSettings);

        // Load about when that page is opened
        document.querySelector('[data-page="about"]').addEventListener('click', loadAbout);
        
        // Load vault configuration on page load
        async function loadVaultConfig() {
            try {
                const res = await fetch(`${API}/api/config/vault`);
                const data = await res.json();
                const hintEl = document.getElementById('vault-hint-text');
                if (data.configured && data.path) {
                    hintEl.innerHTML = `Vault: <code>${data.path}</code> ‚Äî relative paths are supported`;
                } else {
                    hintEl.innerHTML = `Set <code>OBSIDIAN_VAULT_PATH</code> in <code>.env</code> file to use relative paths, or use absolute paths`;
                }
            } catch (e) {
                const hintEl = document.getElementById('vault-hint-text');
                hintEl.textContent = 'Use absolute paths (server not reachable for config)';
            }
        }
        loadVaultConfig();
    </script>
</body>
</html>


